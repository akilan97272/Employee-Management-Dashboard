{% extends "common/layout_base.html" %}

{% block page_title %}Management Console{% endblock %}

{% block content %}

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap');

:root {
  --brand: #6366f1;
  --brand-hover: #4f46e5;
  --brand-soft: rgba(99, 102, 241, 0.1);
  --bg-main: #fcfcfd;
  --surface: #ffffff;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --border-light: #f1f5f9;
  --border-subtle: #e2e8f0;
  --radius-lg: 16px;
  --radius-md: 12px;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.03), 0 2px 4px -2px rgb(0 0 0 / 0.03);
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background-color: var(--bg-main);
  color: var(--text-main);
  -webkit-font-smoothing: antialiased;
}

/* Layout Shell */
.shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 4rem 2rem;
}

.header-section {
  margin-bottom: 3rem;
}

.glass-card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Modern Inputs */
.input-field {
  width: 100%;
  background: var(--bg-main);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
  color: var(--text-main);
  transition: all 0.2s;
}

.input-field:focus {
  outline: none;
  border-color: var(--brand);
  background: #fff;
  box-shadow: 0 0 0 4px var(--brand-soft);
}

/* Data Table Styling */
.table-row {
  display: grid;
  grid-template-columns: 2.5fr 1fr 1fr;
  align-items: center;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--border-light);
  transition: transform 0.2s, background 0.2s;
  text-decoration: none;
  color: inherit;
}

.table-row:hover {
  background: #f8fafc;
  transform: translateY(-1px);
}

.table-row:last-child {
  border-bottom: none;
}

/* Status Badges */
.status-pill {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.status-pill::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.pending { background: #fff7ed; color: #c2410c; }
.pending::before { background: #fb923c; }

.progress { background: #eff6ff; color: #1d4ed8; }
.progress::before { background: #60a5fa; }

.done { background: #f0fdf4; color: #15803d; }
.done::before { background: #4ade80; }

/* Buttons */
.btn-primary {
  background: var(--brand);
  color: white;
  padding: 0.8rem 1.5rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.875rem;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
}

.btn-primary:hover {
  background: var(--brand-hover);
  transform: translateY(-1px);
  box-shadow: 0 6px 15px rgba(99, 102, 241, 0.3);
}

/* Priority Indicators */
.prio-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 12px;
}
.prio-high { background: #f43f5e; box-shadow: 0 0 8px rgba(244, 63, 94, 0.4); }
.prio-med { background: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
.prio-low { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }

.avatar-stack {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
}

.avatar-circle {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid white;
  background: #e2e8f0;
  margin-left: -8px;
}
</style>

<div class="shell">
  <header class="header-section flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold tracking-tight text-slate-900">Task Control</h1>
      <p class="text-slate-500 mt-1">Manage organizational flow and team directives.</p>
    </div>
    <div class="flex items-center gap-3">
      <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Operator</span>
      <div class="px-4 py-2 bg-white border border-slate-200 rounded-full shadow-sm text-xs font-semibold flex items-center gap-2">
        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
        {{ user.name }}
      </div>
    </div>
  </header>

  <div class="grid grid-cols-12 gap-10">
    <div class="col-span-12 lg:col-span-4">
      <div class="glass-card p-8 sticky top-8">
        <h2 class="text-sm font-bold text-slate-900 mb-6 flex items-center gap-2">
            <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Create Directive
        </h2>
        
        <form action="/manager/create_task" method="POST" class="space-y-5">
          <div class="space-y-1">
            <label class="text-[11px] font-bold text-slate-500 uppercase ml-1">Objective Name</label>
            <input type="text" name="title" class="input-field" placeholder="e.g. Q4 Security Audit" required>
          </div>

          <div class="space-y-1">
            <label class="text-[11px] font-bold text-slate-500 uppercase ml-1">Assign Lead</label>
            <div class="relative">
                <input id="taskAssigneeSearch" type="text" class="input-field" placeholder="Search team member...">
                <div id="taskAssigneeCards" class="hidden absolute left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-30 max-h-48 overflow-y-auto p-2"></div>
                <input type="hidden" id="taskAssignees" name="assignees" value="">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 pt-2">
            <div class="space-y-1">
              <label class="text-[11px] font-bold text-slate-500 uppercase ml-1">Priority</label>
              <select name="priority" class="input-field appearance-none">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="space-y-1">
              <label class="text-[11px] font-bold text-slate-500 uppercase ml-1">Due Date</label>
              <input type="date" name="due_date" class="input-field">
            </div>
          </div>

          <button type="submit" class="btn-primary w-full mt-4">Initialize Task</button>
        </form>
      </div>
    </div>

    <div class="col-span-12 lg:col-span-8">
      <div class="glass-card">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Directives</h3>
          <span class="text-[11px] font-medium text-slate-400">{{ tasks|length }} Total</span>
        </div>
        
        <div class="divide-y divide-slate-50">
          {% for task in tasks %}
          <div class="table-row cursor-pointer" onclick="openTaskDetail(this)"
            data-id="{{ task.id }}"
            data-title="{{ task.title | e }}"
            data-description="{{ task.description | e }}"
            data-assignee="{{ task.assignee.name if task.assignee else '' }}"
            data-assignees="{{ task.user_id }}"
            data-project="{{ task.project_info.name if task.project_info else 'No project' }}"
            data-priority="{{ task.priority }}"
            data-status="{{ task.status }}"
            data-dueDate="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
            
            <div class="flex items-center">
              <div class="prio-dot {{ 'prio-high' if task.priority == 'high' else 'prio-med' if task.priority == 'medium' else 'prio-low' }}"></div>
              <div>
                <div class="text-sm font-semibold text-slate-800">{{ task.title }}</div>
                <div class="flex items-center gap-2 mt-1">
                    <span class="font-mono text-[10px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">#{{ task.id }}</span>
                    <span class="text-[11px] text-slate-400 font-medium">Due {{ task.due_date.strftime('%b %d') if task.due_date else 'No Date' }}</span>
                </div>
              </div>
            </div>

            <div class="avatar-stack">
              <div class="avatar-circle"></div>
              <div class="avatar-circle" style="background: #cbd5e1;"></div>
            </div>

            <div class="text-right">
              <span class="status-pill {{ 'pending' if task.status == 'pending' else 'progress' if task.status == 'in-progress' else 'done' }}">
                {{ task.status | title }}
              </span>
            </div>
          </div>
          {% else %}
          <div class="py-20 text-center">
            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            </div>
            <p class="text-slate-400 text-sm">Workspace is clear. No active directives.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div id="taskDetailModal" class="fixed inset-0 hidden items-center justify-center z-50 p-4">
  <div id="taskDetailBackdrop" class="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity" onclick="closeTaskDetail()"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
    <div class="h-2 bg-indigo-500"></div>
    <div class="p-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 id="taskDetailTitle" class="text-xl font-bold text-slate-900">Task Details</h2>
          <p id="taskDetailMeta" class="text-slate-500 text-sm mt-1">-</p>
        </div>
        <button onclick="closeTaskDetail()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <div class="mb-4">
        <div id="taskDetailAssignees" class="text-sm text-slate-600 mb-3">-</div>
        <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm text-slate-700" id="taskDetailDescription">-</div>
      </div>

      <form action="/manager/tasks/update" method="POST" class="space-y-3">
        <input type="hidden" id="taskEditId" name="task_id" value="">
        <div>
          <label class="text-xs font-bold text-slate-500">Title</label>
          <input id="taskEditTitle" name="title" class="input-field mt-1" />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500">Description</label>
          <textarea id="taskEditDescription" name="description" class="input-field mt-1 h-24"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs font-bold text-slate-500">Priority</label>
            <select id="taskEditPriority" name="priority" class="input-field mt-1">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500">Status</label>
            <select id="taskEditStatus" name="status" class="input-field mt-1">
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500">Due Date</label>
          <input id="taskEditDueDate" name="due_date" type="date" class="input-field mt-1" />
        </div>

        <div class="flex gap-3 pt-2">
          <button type="submit" class="btn-primary flex-1">Save Changes</button>
          <button type="button" id="taskDeleteBtn" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold text-red-600 hover:bg-slate-50">Delete</button>
          <input type="hidden" id="taskDeleteId" name="task_delete_id" value="">
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openTaskDetail(el) {
    document.getElementById('modalTitle').innerText = el.dataset.title;
    const modal = document.getElementById('taskDetailModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeTaskDetail() {
    const modal = document.getElementById('taskDetailModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}
</script>





<script>
const taskSearch = document.getElementById('taskAssigneeSearch');
const taskCards = document.getElementById('taskAssigneeCards');
const taskAssigneesInput = document.getElementById('taskAssignees');
const selectedIds = new Set();
let searchTimer = null;

function renderTaskResults(items) {
  if (!taskCards) return;
  taskCards.innerHTML = '';
  if (!items.length) {
    taskCards.classList.add('hidden');
    return;
  }
  items.forEach(emp => {
    const card = document.createElement('div');
    card.className = 'assignee-card task-assignee-card';
    card.dataset.empId = emp.employee_id;
    card.dataset.empName = emp.name;
    if (selectedIds.has(emp.employee_id)) {
      card.classList.add('active');
    }

    const left = document.createElement('div');
    left.innerHTML = `${emp.name} <span class="mono">#${emp.employee_id}</span>`;
    const check = document.createElement('div');
    check.className = 'assignee-check' + (selectedIds.has(emp.employee_id) ? '' : ' hidden');
    check.textContent = '✓';

    card.appendChild(left);
    card.appendChild(check);

    card.addEventListener('click', () => {
      const id = emp.employee_id;
      if (selectedIds.has(id)) {
        selectedIds.delete(id);
        card.classList.remove('active');
        check.classList.add('hidden');
      } else {
        selectedIds.add(id);
        card.classList.add('active');
        check.classList.remove('hidden');
      }
      taskAssigneesInput.value = Array.from(selectedIds).join(',');
    });

    taskCards.appendChild(card);
  });
  taskCards.classList.remove('hidden');
}

async function fetchParticipants(term) {
  const response = await fetch(`/manager/participant_search?q=${encodeURIComponent(term)}`);
  if (!response.ok) return [];
  return await response.json();
}

if (taskSearch) {
  taskSearch.addEventListener('input', () => {
    const term = taskSearch.value.trim();
    if (!term) {
      taskCards.classList.add('hidden');
      return;
    }
    if (searchTimer) {
      clearTimeout(searchTimer);
    }
    searchTimer = setTimeout(async () => {
      const results = await fetchParticipants(term);
      renderTaskResults(Array.isArray(results) ? results : []);
    }, 200);
  });
}

const today = new Date().toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(input => {
  input.min = today;
});

const taskFilterButtons = Array.from(document.querySelectorAll('[data-filter]'));
const taskCardsList = Array.from(document.querySelectorAll('.task-card'));

function applyTaskFilter(status) {
  taskCardsList.forEach(card => {
    const cardStatus = card.dataset.status || '';
    if (status === 'all' || cardStatus === status) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

taskFilterButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    taskFilterButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyTaskFilter(btn.dataset.filter || 'all');
  });
});

const taskDetailModal = document.getElementById('taskDetailModal');
const taskDetailBackdrop = document.getElementById('taskDetailBackdrop');
const taskDetailClose = document.getElementById('closeTaskDetail');

function parseAssignees(value) {
  return (value || '')
    .split(',')
    .map(item => item.trim())
    .filter(Boolean);
}

function renderAssigneePreview(card) {
  const container = card.querySelector('[data-assignee-preview]');
  if (!container) return;
  const list = parseAssignees(card.dataset.assignees);
  container.innerHTML = '';
  if (!list.length) return;

  const preview = list.slice(0, 2);
  preview.forEach(name => {
    const pill = document.createElement('span');
    pill.className = 'assignee-pill';
    pill.textContent = name;
    container.appendChild(pill);
  });

  if (list.length > 2) {
    const more = document.createElement('span');
    more.className = 'assignee-pill';
    more.textContent = `+${list.length - 2}`;
    container.appendChild(more);
  }
}

function openTaskDetail(card) {
  document.getElementById('taskDetailTitle').textContent = card.dataset.title || '-';
  document.getElementById('taskDetailMeta').textContent = `${card.dataset.assignee || '-'} · ${card.dataset.project || 'No project'}`;
  const fullAssignees = parseAssignees(card.dataset.assignees);
  const assigneesEl = document.getElementById('taskDetailAssignees');
  assigneesEl.innerHTML = '';
  if (!fullAssignees.length) {
    assigneesEl.textContent = '-';
  } else {
    fullAssignees.forEach(name => {
      const row = document.createElement('div');
      row.textContent = name;
      assigneesEl.appendChild(row);
    });
  }
  document.getElementById('taskEditId').value = card.dataset.id || '';
  document.getElementById('taskDeleteId').value = card.dataset.id || '';
  document.getElementById('taskEditTitle').value = card.dataset.title || '';
  document.getElementById('taskEditDescription').value = card.dataset.description || '';
  document.getElementById('taskEditPriority').value = card.dataset.priority || 'medium';
  document.getElementById('taskEditStatus').value = card.dataset.status || 'pending';
  document.getElementById('taskEditDueDate').value = card.dataset.dueDate || '';
  taskDetailModal.classList.remove('hidden');
  taskDetailModal.classList.add('flex');
}

function closeTaskDetail() {
  taskDetailModal.classList.add('hidden');
  taskDetailModal.classList.remove('flex');
}

taskCardsList.forEach(card => {
  card.addEventListener('click', () => openTaskDetail(card));
  renderAssigneePreview(card);
});

if (taskDetailBackdrop) taskDetailBackdrop.addEventListener('click', closeTaskDetail);
if (taskDetailClose) taskDetailClose.addEventListener('click', closeTaskDetail);

// Delete task via fetch to avoid nested forms
const taskDeleteBtn = document.getElementById('taskDeleteBtn');
if (taskDeleteBtn) {
  taskDeleteBtn.addEventListener('click', async () => {
    const id = document.getElementById('taskDeleteId').value || document.getElementById('taskEditId').value;
    if (!id) return;
    if (!confirm('Delete this task? This action cannot be undone.')) return;
    const fd = new FormData();
    fd.append('task_id', id);
    try {
      const res = await fetch('/manager/tasks/delete', { method: 'POST', body: fd });
      if (res.redirected) {
        window.location = res.url;
      } else {
        window.location.reload();
      }
    } catch (err) {
      console.error('Delete failed', err);
      window.location.reload();
    }
  });
}
</script>
{% endblock %}
