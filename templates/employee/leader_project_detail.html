{% extends "common/layout_base.html" %}
{% block content %}
  <a href="/leader/dashboard" class="inline-flex items-center mb-6 px-4 py-2 rounded-lg bg-gray-100 hover:bg-blue-100 text-blue-700 font-bold border border-blue-200 shadow-sm">
    <i class="fas fa-arrow-left mr-2"></i> Back
  </a>
<div class="max-w-3xl mx-auto py-10">
  <h2 class="text-2xl font-black mb-8 text-blue-700">Project: {{ project.name }}</h2>
  <div class="neo-card p-6 mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-lg font-bold text-blue-700">Department: {{ project.department }}</div>
        <div class="text-xs opacity-60 mt-1">Due: {{ project.deadline.strftime('%Y-%m-%d') }}</div>
      </div>
      <div class="text-xs font-bold text-gray-500">Project ID: {{ project.id }}</div>
    </div>
  </div>

  <h3 class="text-xl font-bold mb-4">Assigned Tasks</h3>
  <div class="grid grid-cols-1 gap-6">
    {% for task in project.tasks %}
    <div class="neo-card p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4 hover:shadow-xl transition-shadow relative">
      <div class="flex items-center gap-4">
        {% if task.assignees and task.assignees[0].employee.photo_path %}
        <img src="{{ task.assignees[0].employee.photo_path }}" alt="{{ task.assignees[0].employee.name }}" class="w-14 h-14 rounded-full object-cover border-2 border-blue-400" />
        {% else %}
        <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center text-2xl font-bold text-blue-700 border-2 border-blue-200">{{ task.assignees[0].employee.name[0] if task.assignees else '?' }}</div>
        {% endif %}
        <div>
          <div class="font-bold text-lg">{{ task.title }}</div>
          <div class="text-xs opacity-60">Assigned to:
            {% for a in task.assignees %}
              <span class="font-bold">
                {{ a.employee.name }}
                {% if a.status == 'completed' %}
                  <span class="ml-1 text-green-600">&#10003; Completed</span>
                {% elif a.status == 'in-progress' %}
                  <span class="ml-1 text-yellow-600">In Progress</span>
                {% else %}
                  <span class="ml-1 text-gray-400">Pending</span>
                {% endif %}
              </span>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </div>
          <div class="text-xs opacity-60">Employee ID:
            {% for a in task.assignees %}{{ a.employee.employee_id }}{% if not loop.last %}, {% endif %}{% endfor %}
          </div>
        </div>
      </div>
      <div class="flex flex-col gap-1 text-xs text-right">
        <div>Assigned: <span class="font-bold">{{ task.created_at.strftime('%Y-%m-%d') if task.created_at else '-' }}</span></div>
        <div>Due: <span class="font-bold">{{ task.deadline.strftime('%Y-%m-%d') if task.deadline else '-' }}</span></div>
        <div>Completed: <span class="font-bold">{{ task.completed_at.strftime('%Y-%m-%d') if task.completed_at else '-' }}</span></div>
        <div>Status: <span class="font-bold capitalize {% if task.status == 'completed' %}text-green-600{% elif task.status == 'in-progress' %}text-yellow-600{% else %}text-gray-500{% endif %}">{{ task.status }}</span></div>
      </div>
      <div class="mt-2 md:mt-0 text-sm text-gray-700 dark:text-gray-200">{{ task.description or 'No description provided.' }}</div>
      {% set assignees = [] %}
      {% for a in task.assignees %}
        {% set _ = assignees.append({'employee_id': a.employee.employee_id, 'name': a.employee.name}) %}
      {% endfor %}
      {% set task_obj = {
        'id': task.id,
        'title': task.title,
        'description': task.description or '',
        'deadline': task.deadline.isoformat() if task.deadline else '',
        'assignees': assignees
      } %}
      <div class="absolute top-3 right-3 flex gap-2">
        <button type="button" class="px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-300 shadow-sm" onclick='openEditTaskModal(JSON.parse(`{{ task_obj|tojson|safe }}`))'><i class="fas fa-edit mr-1"></i>Edit</button>
        <form id="delete-task-{{ task.id }}" method="post" action="/leader/delete_task" class="inline" onsubmit="return confirm('Delete this task?');">
          <input type="hidden" name="task_id" value="{{ task.id }}" />
          <button type="submit" class="px-3 py-1 text-xs font-bold rounded bg-red-100 text-red-700 hover:bg-red-200 border border-red-300 shadow-sm"><i class="fas fa-trash mr-1"></i>Delete</button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="text-center opacity-50">No tasks assigned for this project.</div>
    {% endfor %}
  </div>
<!-- Edit Task Modal -->
{% include 'employee/edit_task_modal.html' %}
{% set leader_team_members = [] %}
{% for member in team.members %}
  {% if member.id != user.id %}
    {% set _ = leader_team_members.append({'employee_id': member.employee_id, 'name': member.name}) %}
  {% endif %}
{% endfor %}
<script>
window.leaderTeamMembers = JSON.parse(`{{ leader_team_members|tojson|safe }}`);
</script>
</div>
{% endblock %}
