{% extends "common/layout_base.html" %}

{% block page_title %}My Team{% endblock %}

{% block content %}


<style>
/* =========================================
   PREMIUM CORPORATE TEAM STYLES
   ========================================= */

:root {
  --glass-bg: rgba(255, 255, 255, 0.88);
  --glass-border: rgba(226, 232, 240, 0.7);
  --corp-navy: #0f172a;
  --accent-indigo: #6366f1;
}

/* Header Banner */
.team-banner {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border-radius: 1.5rem;
  padding: 2.5rem;
  color: white;
  position: relative;
  overflow: hidden;
}

.team-banner::after {
  content: "";
  position: absolute;
  top: -50%;
  right: -10%;
  width: 300px;
  height: 300px;
  background: rgba(99, 102, 241, 0.1);
  border-radius: 50%;
  filter: blur(60px);
}

/* Member Card Polish */
.member-card {
  background: var(--glass-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.member-card:hover {
  transform: translateY(-5px);
  border-color: var(--accent-indigo);
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
}

/* Avatar Styling */
.member-avatar {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.25rem;
  background: #f1f5f9;
  color: #475569;
}

.leader-avatar {
  background: var(--accent-indigo);
  color: white;
  box-shadow: 0 8px 15px -3px rgba(99, 102, 241, 0.4);
}

/* Badges */
.badge-premium {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 4px 10px;
  border-radius: 6px;
}

.badge-leader {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(4px);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.project-card {
  background: var(--glass-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}

.project-card:hover {
  transform: translateY(-4px);
  border-color: var(--accent-indigo);
  box-shadow: 0 16px 24px -8px rgba(0, 0, 0, 0.05);
}

.reveal {
  opacity: 0;
  transform: translateY(15px);
  animation: slideUp 0.6s ease forwards;
}

@keyframes slideUp {
  to { opacity: 1; transform: translateY(0); }
}

/* ðŸ”¥ DEBUG FORCE VISIBILITY */
.collaborators,
.leadership-hub,
.team-members,
[data-team],
[data-member] {
  opacity: 1 !important;
  transform: none !important;
  visibility: visible !important;
}
</style>

<div class="max-w-6xl mx-auto space-y-8 p-4">

{% if teams_data %}
  <div class="flex items-center justify-end gap-3 px-2">
    <select id="memberStatusFilter" class="text-[10px] font-black uppercase tracking-widest text-slate-500 bg-white border border-slate-200 rounded px-3 py-2">
      <option value="all">All</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>

  {% for item in teams_data %}
  {% if item.team.leader_id == user.id %}
  <div class="flex justify-end mb-2">
    <a href="/leader/dashboard" class="inline-block px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition-all text-xs uppercase tracking-widest">Leader Dashboard</a>
  </div>
  {% endif %}
  <header class="team-banner">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative z-10">
      <div>
        {% if user.current_team_id == item.team.id %}
        <span class="badge-premium badge-leader mb-2 inline-block">Official Team</span>
        {% endif %}
        <h2 class="text-4xl font-black tracking-tighter">{{ item.team.name }}</h2>
        <p class="text-slate-400 font-medium mt-1">
          Operating under <span class="text-indigo-300">{{ item.team.department }}</span> Division
        </p>
      </div>
      
      <div class="flex gap-4">
        <div class="text-center px-6 border-r border-slate-700">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total Force</p>
          <p class="text-2xl font-black text-white">{{ item.members|length }}</p>
        </div>
        <div class="text-center px-6">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Team ID</p>
          <p class="text-2xl font-black text-white">#{{ item.team.id|default('01') }}</p>
        </div>
      </div>
    </div>
  </header>

  <section class="space-y-4">
    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest px-2">Leadership Hub</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% if item.leader %}
      <div class="member-card p-6 rounded-[1.5rem] flex items-center gap-5 border-l-4 border-l-indigo-500">
        <div class="member-avatar leader-avatar">
          {{ item.leader.name[0] }}
        </div>
        <div>
          <h4 class="font-extrabold text-slate-900 leading-tight">{{ item.leader.name }}</h4>
          <p class="text-xs font-bold text-indigo-600 uppercase tracking-wider mt-0.5">Team Leader</p>
        </div>
        <div class="ml-auto">
            <span class="text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </span>
        </div>
      </div>
      {% else %}
      <div class="member-card p-6 rounded-[1.5rem] flex items-center gap-5 border-l-4 border-l-slate-200">
        <div class="member-avatar">?</div>
        <div>
          <h4 class="font-extrabold text-slate-900 leading-tight">Leader Unassigned</h4>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mt-0.5">Team Leader</p>
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="space-y-4">
    <div class="flex items-center justify-between px-2">
      <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Collaborators</h3>
      <div class="h-px bg-slate-100 flex-1 mx-4"></div>
    </div>

    {% if item.members %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 max-h-80 overflow-auto pr-1">
      {% for m in item.members %}
        {% if not item.leader or m.id != item.leader.id %}
        <div class="member-card p-5 rounded-2xl flex items-center gap-4" data-member-status="{{ 'active' if m.is_active else 'inactive' }}">
          <div class="member-avatar {% if m.active_leader %}leader-avatar{% endif %}">
            {{ m.name[0] }}
          </div>
          <div>
            <p class="font-bold text-slate-900 text-sm tracking-tight">{{ m.name }}</p>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">{{ m.role if m.role else 'Member' }}</p>
          </div>
          {% if m.active_leader %}
          <div class="ml-auto text-amber-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
          </div>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    </div>
    {% else %}
    <p class="italic text-slate-400 py-6">No collaborators assigned</p>
    {% endif %}
  </section>
  {% endfor %}

  <section class="space-y-6">
    <div class="flex items-center justify-between px-2">
      <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Assigned Tasks</h3>
      <div class="h-px bg-slate-100 flex-1 mx-4"></div>
    </div>

    {% if assigned_tasks %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for task in assigned_tasks %}
        <div class="member-card p-5 rounded-2xl flex flex-col gap-3" id="project-task-{{ task.id }}">
          <script>
            // Highlight and scroll to project task if hash is present
            document.addEventListener('DOMContentLoaded', function() {
              if (window.location.hash.startsWith('#project-task-')) {
                const el = document.querySelector(window.location.hash);
                if (el) {
                  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  el.classList.add('ring-4', 'ring-indigo-400', 'ring-opacity-60');
                  setTimeout(() => {
                    el.classList.remove('ring-4', 'ring-indigo-400', 'ring-opacity-60');
                  }, 1800);
                }
              }
            });
          </script>
          <div class="flex items-start justify-between">
            <div>
              <h4 class="font-extrabold text-slate-900 text-sm tracking-tight">{{ task.title }}</h4>
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
                Project: {{ task.project.name if task.project else 'Personal' }}
              </p>
            </div>
            <span class="text-[9px] font-black uppercase tracking-widest px-2 py-1 rounded-full
              {% if task.status == 'done' %} bg-emerald-100 text-emerald-700
              {% elif task.status == 'in-progress' %} bg-blue-100 text-blue-700
              {% else %} bg-amber-100 text-amber-700 {% endif %}
            ">
              {{ task.status }}
            </span>
          </div>
          {% if task.description %}
            <p class="text-xs text-slate-500">{{ task.description }}</p>
          {% endif %}
          <div class="flex items-center gap-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider">
            <span>Priority: {{ task.priority }}</span>
            {% if task.due_date %}
              <span>Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="italic text-slate-400">No assigned tasks yet</p>
    {% endif %}
  </section>

  <section class="space-y-6">
    <div class="flex items-center justify-between px-2">
      <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Team Projects</h3>
      <div class="h-px bg-slate-100 flex-1 mx-4"></div>
    </div>

    {% if teams_data %}
      {% for item in teams_data %}
        {% set team_projects = projects_by_team.get(item.team.id, []) %}
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="text-xs font-black uppercase tracking-widest text-slate-500">{{ item.team.name }}</h4>
            <span class="text-[10px] font-bold text-slate-400">Team Projects</span>
          </div>
          {% if team_projects %}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for project in team_projects %}
            <div class="project-card p-5 rounded-2xl"
                 data-project-name="{{ project.name }}"
                 data-project-status="{{ project.status or 'active' }}"
                 data-project-department="{{ project.department or 'N/A' }}"
                 data-project-deadline="{{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'TBD' }}"
                 data-project-tasks="{{ project_task_counts.get(project.id, 0) }}"
                 data-project-description="{{ project.description or 'No description provided' }}"
                 data-project-task-items='{{ project_tasks_map.get(project.id, []) | tojson }}'>
              <div class="flex items-center justify-between">
                <h4 class="font-extrabold text-slate-900 text-sm tracking-tight">{{ project.name }}</h4>
                <span class="text-[9px] font-black uppercase tracking-widest text-indigo-600">
                  {{ project.status or 'active' }}
                </span>
              </div>
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-2">
                Department: {{ project.department or 'N/A' }}
              </p>
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
                Deadline: {{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'TBD' }}
              </p>
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
                Tasks: {{ project_task_counts.get(project.id, 0) }}
              </p>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="italic text-slate-400">No projects linked to this team</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="italic text-slate-400">No team projects available</p>
    {% endif %}
  </section>

{% else %}
  <div class="glass p-20 rounded-[3rem] text-center">
    <div class="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
    </div>
    <h3 class="text-xl font-black text-slate-900 tracking-tight">Deployment Pending</h3>
    <p class="text-slate-500 font-medium mt-2 max-w-sm mx-auto">
      You are not currently assigned to a strategic unit. Please contact HR or your manager for team onboarding.
    </p>
  </div>
{% endif %}

  <section class="space-y-6">
    <div class="flex items-center justify-between px-2">
      <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Additional Projects</h3>
      <div class="h-px bg-slate-100 flex-1 mx-4"></div>
    </div>

    {% if additional_projects %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for project in additional_projects %}
        <div class="project-card p-5 rounded-2xl"
             data-project-name="{{ project.name }}"
             data-project-status="{{ project.status or 'active' }}"
             data-project-department="{{ project.department or 'N/A' }}"
             data-project-deadline="{{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'TBD' }}"
             data-project-tasks="{{ project_task_counts.get(project.id, 0) }}"
             data-project-description="{{ project.description or 'No description provided' }}"
             data-project-task-items='{{ project_tasks_map.get(project.id, []) | tojson }}'>
          <div class="flex items-center justify-between">
            <h4 class="font-extrabold text-slate-900 text-sm tracking-tight">{{ project.name }}</h4>
            <span class="text-[9px] font-black uppercase tracking-widest text-indigo-600">
              {{ project.status or 'active' }}
            </span>
          </div>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-2">
            Department: {{ project.department or 'N/A' }}
          </p>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
            Deadline: {{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'TBD' }}
          </p>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">
            Tasks: {{ project_task_counts.get(project.id, 0) }}
          </p>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="italic text-slate-400">No additional projects assigned</p>
    {% endif %}
  </section>

  <div id="projectDetailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white w-full max-w-xl p-10 border border-slate-200 relative">
      <div class="h-2 w-full bg-slate-900 absolute top-0 left-0"></div>
      <button onclick="closeProjectModal()" class="absolute top-6 right-6 text-slate-300 hover:text-slate-900">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>

      <div class="space-y-6">
        <div>
          <h3 id="projectModalName" class="text-3xl font-black uppercase tracking-tighter text-slate-900"></h3>
          <p id="projectModalMeta" class="executive-mono text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-2"></p>
        </div>

        <div class="border border-slate-100 bg-slate-50 p-4">
          <p class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3">Task Volume</p>
          <div class="text-sm font-black text-slate-900 uppercase tracking-tight" id="projectModalTasks"></div>
        </div>

        <div class="border border-slate-100 bg-slate-50 p-4">
          <p class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3">Operational Scope</p>
          <p id="projectModalDescription" class="text-sm text-slate-700 leading-relaxed"></p>
        </div>

        <div class="border border-slate-100 bg-slate-50 p-4">
          <p class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3">Deployment Log</p>
          <div id="projectModalTasksList" class="space-y-2 text-sm text-slate-700 max-h-64 overflow-auto pr-1"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const filter = document.getElementById('memberStatusFilter');
    if (!filter) return;

    const cards = document.querySelectorAll('[data-member-status]');

    function applyFilter() {
      const value = filter.value;
      cards.forEach(card => {
        const status = card.getAttribute('data-member-status');
        const shouldShow = value === 'all' || status === value;
        card.style.display = shouldShow ? '' : 'none';
      });
    }

    filter.addEventListener('change', applyFilter);
    applyFilter();
  });

  function openProjectModal(card) {
    const name = card.getAttribute('data-project-name') || '';
    const status = card.getAttribute('data-project-status') || 'active';
    const department = card.getAttribute('data-project-department') || 'N/A';
    const deadline = card.getAttribute('data-project-deadline') || 'TBD';
    const tasks = card.getAttribute('data-project-tasks') || '0';
    const description = card.getAttribute('data-project-description') || 'No description provided';
    const taskItemsRaw = card.getAttribute('data-project-task-items') || '[]';
    let taskItems = [];
    try {
      taskItems = JSON.parse(taskItemsRaw);
    } catch (e) {
      taskItems = [];
    }

    window.activeProjectCard = card;
    window.activeProjectTasks = taskItems;

    document.getElementById('projectModalName').textContent = name;
    document.getElementById('projectModalMeta').textContent = `Status: ${status} â€¢ Dept: ${department} â€¢ Deadline: ${deadline}`;
    const completedCount = taskItems.filter(item => item.status === 'completed').length;
    document.getElementById('projectModalTasks').textContent = `${completedCount}/${taskItems.length} tasks completed`;
    document.getElementById('projectModalDescription').textContent = description;
    const list = document.getElementById('projectModalTasksList');
    if (list) {
      if (taskItems.length === 0) {
        list.innerHTML = '<p class="text-xs text-slate-500">No tasks in this project</p>';
      } else {
        list.innerHTML = taskItems.map(item => {
          const deadlineLabel = item.deadline ? `Deadline: ${item.deadline}` : 'No deadline';
          const isDone = item.status === 'completed';
          const actionMarkup = isDone
            ? '<span class="text-[9px] font-black uppercase tracking-widest text-emerald-600">Completed</span>'
            : `
              <button type="button"
                      class="text-[9px] font-black uppercase tracking-widest text-indigo-600 hover:text-indigo-800"
                      data-task-id="${item.id}"
                      onclick="markProjectTaskComplete(this)">
                Mark Complete
              </button>
            `;
          return `
            <div class="border border-slate-200 rounded-lg p-3">
              <div class="flex items-center justify-between">
                <div class="font-bold text-slate-900">${item.title}</div>
                ${actionMarkup}
              </div>
              <div class="text-xs text-slate-600 mt-2">${item.description || ''}</div>
              <div class="text-[10px] text-slate-400 mt-2">${deadlineLabel}</div>
            </div>
          `;
        }).join('');
      }
    }

    document.getElementById('projectDetailModal').classList.remove('hidden');
  }

  function closeProjectModal() {
    document.getElementById('projectDetailModal').classList.add('hidden');
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.project-card').forEach(card => {
      card.addEventListener('click', function() {
        openProjectModal(this);
      });
      card.addEventListener('touchstart', function() {
        openProjectModal(this);
      }, { passive: true });
    });
  });

  function markProjectTaskComplete(button) {
    const taskId = button.getAttribute('data-task-id');
    if (!taskId) return;

    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed');

    const formData = new FormData();
    formData.append('task_id', taskId);

    fetch('/employee/project_tasks/complete', {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to update task');
        }
        const parent = button.parentElement;
        parent.innerHTML = '<span class="text-[9px] font-black uppercase tracking-widest text-emerald-600">Completed</span>';

        if (window.activeProjectTasks) {
          window.activeProjectTasks = window.activeProjectTasks.map(item => {
            if (String(item.id) === String(taskId)) {
              return { ...item, status: 'completed' };
            }
            return item;
          });
        }

        if (window.activeProjectCard && window.activeProjectTasks) {
          window.activeProjectCard.setAttribute('data-project-task-items', JSON.stringify(window.activeProjectTasks));
          const doneCount = window.activeProjectTasks.filter(item => item.status === 'completed').length;
          document.getElementById('projectModalTasks').textContent = `${doneCount}/${window.activeProjectTasks.length} tasks completed`;
        }
      })
      .catch(() => {
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
        alert('Unable to mark task complete. Please try again.');
      });
  }
</script>

{% endblock %}