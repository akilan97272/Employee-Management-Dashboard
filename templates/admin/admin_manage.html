{% extends "common/layout_base.html" %}

{% block title %}Personnel Directory | TeamSync{% endblock %}

{% block page_title %}Personnel Management{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6 pb-12">
  
  {# Status Notification #}
  {% if request.query_params.get('removed') %}
    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 mb-4" id="employeeRemovedFlag">
      <p class="text-sm text-emerald-800 font-medium">Employee record has been successfully removed from the system.</p>
    </div>
  {% endif %}

  {# Search and Filter Bar #}
  <div class="bg-white border border-slate-200 shadow-sm p-5">
    <form method="get" action="/admin/manage_employees" class="grid grid-cols-1 md:grid-cols-12 gap-4">
      <div class="md:col-span-6 relative">
        <label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">Search Directory</label>
        <div class="relative">
          <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input name="search" placeholder="Name, Email, or ID..."
                 class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-300 text-sm focus:ring-0 focus:border-slate-900 transition-all rounded-none" 
                 value="{{ search or '' }}"/>
        </div>
      </div>

      <div class="md:col-span-3">
        <label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">Department</label>
        <select name="department" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 text-sm focus:border-slate-900 rounded-none">
          <option value="">All Departments</option>
          <option value="IT" {% if department == 'IT' %}selected{% endif %}>Information Technology</option>
          <option value="HR" {% if department == 'HR' %}selected{% endif %}>Human Resources</option>
          <option value="Finance" {% if department == 'Finance' %}selected{% endif %}>Finance</option>
        </select>
      </div>

      <div class="md:col-span-3 flex items-end">
        <button class="w-full py-2 bg-slate-800 text-white text-xs font-bold uppercase tracking-wider hover:bg-slate-700 transition-colors rounded-none">
          Update Results
        </button>
      </div>
    </form>
  </div>

  {# Directory Header #}
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h2 class="text-xl font-bold text-slate-900">Active Directory</h2>
      <p class="text-sm text-slate-500">Managing {{ total_count }} total employee records</p>
    </div>
    <a href="/admin/register_employee" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-indigo-600 text-white text-xs font-bold uppercase tracking-wider hover:bg-indigo-700 transition-all rounded-none">
      <i class="bi bi-plus-lg"></i>
      Add New Employee
    </a>
  </div>

  {# Directory Table-Style List #}
  <div class="border border-slate-200 bg-white shadow-sm overflow-hidden">
    {# Header Row (Hidden on Mobile) #}
    <div class="hidden md:grid grid-cols-12 gap-4 px-6 py-3 bg-slate-50 border-b border-slate-200 text-[11px] font-bold text-slate-500 uppercase tracking-wider">
      <div class="col-span-1">Photo</div>
      <div class="col-span-4">Employee Details</div>
      <div class="col-span-2">ID Number</div>
      <div class="col-span-2">Department</div>
      <div class="col-span-2">Access Role</div>
      <div class="col-span-1 text-right">Actions</div>
    </div>

    <div class="divide-y divide-slate-100">
      {% for emp in employees %}
      <div class="group hover:bg-slate-50 transition-colors cursor-pointer" data-employee-card data-detail-url="/admin/employee_details?employee_id={{ emp.employee_id }}">
        <div class="grid grid-cols-12 gap-4 px-6 py-5 items-center">
          
          {# Photo #}
          <div class="col-span-3 md:col-span-1">
            {% if emp.photo_blob or emp.photo_path %}
              <img src="{{ '/employee/photo/' ~ emp.employee_id if emp.photo_blob else emp.photo_path }}" 
                   class="w-10 h-10 object-cover border border-slate-200 rounded-none" />
            {% else %}
              <div class="w-10 h-10 bg-slate-200 text-slate-600 flex items-center justify-center text-[10px] font-bold rounded-none">
                {{ emp.name[:1] }}{{ emp.name.split(' ')[-1][:1] if ' ' in emp.name else '' }}
              </div>
            {% endif %}
          </div>

          {# Name & Email #}
          <div class="col-span-9 md:col-span-4">
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-slate-900">{{ emp.name }}</span>
              {% if emp.is_active %}
                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 bg-emerald-100 text-emerald-700">Active</span>
              {% else %}
                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 bg-slate-100 text-slate-500">Inactive</span>
              {% endif %}
            </div>
            <div class="text-xs text-slate-500">{{ emp.email }}</div>
          </div>

          {# ID #}
          <div class="col-span-6 md:col-span-2">
            <span class="md:hidden block text-[10px] font-bold text-slate-400 uppercase">ID</span>
            <span class="text-xs font-medium text-slate-700 font-mono">{{ emp.employee_id }}</span>
          </div>

          {# Department #}
          <div class="col-span-6 md:col-span-2">
            <span class="md:hidden block text-[10px] font-bold text-slate-400 uppercase">Dept</span>
            <span class="text-xs text-slate-600 uppercase">{{ emp.department }}</span>
          </div>

          {# Role #}
          <div class="col-span-6 md:col-span-2">
            <span class="md:hidden block text-[10px] font-bold text-slate-400 uppercase">Role</span>
            <span class="text-[10px] font-bold text-slate-600 uppercase border border-slate-200 px-2 py-0.5 inline-block">
              {{ emp.role }}
            </span>
          </div>

          {# Actions #}
          <div class="col-span-6 md:col-span-1 flex justify-end gap-1">
            <a href="/admin/edit_employee?employee_id={{ emp.employee_id }}" 
               class="p-2 text-slate-400 hover:text-indigo-600 transition-colors" data-stop-card title="Edit">
              <i class="bi bi-pencil-square"></i>
            </a>
            <form action="/admin/remove_employee" method="post" class="inline" data-stop-card>
              <input type="hidden" name="employee_id" value="{{ emp.employee_id }}">
              <button class="p-2 text-slate-400 hover:text-red-600 transition-colors" title="Delete">
                <i class="bi bi-trash3"></i>
              </button>
            </form>
          </div>

        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {# Pagination #}
  {% if total_pages > 1 %}
  <div class="flex items-center justify-between border-t border-slate-200 pt-6">
    <div class="text-xs font-medium text-slate-500">Showing page {{ page }} of {{ total_pages }}</div>
    <div class="flex gap-px bg-slate-200">
      {% if page > 1 %}
      <a class="px-4 py-2 bg-white text-xs font-bold text-slate-700 hover:bg-slate-50 border border-slate-200"
         href="/admin/manage_employees?search={{ search or '' }}&department={{ department or '' }}&page={{ page - 1 }}">Previous</a>
      {% endif %}
      {% if page < total_pages %}
      <a class="px-4 py-2 bg-white text-xs font-bold text-slate-700 hover:bg-slate-50 border border-slate-200"
         href="/admin/manage_employees?search={{ search or '' }}&department={{ department or '' }}&page={{ page + 1 }}">Next</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

{# Minimal Professional Modal #}
<div id="deleteEmployeeModal" class="fixed inset-0 hidden items-center justify-center bg-slate-900/60 z-50 backdrop-blur-sm">
  <div class="bg-white rounded-none w-full max-w-md shadow-xl">
    <div class="p-6 border-b border-slate-100">
      <h3 class="text-lg font-bold text-slate-900">Confirm Removal</h3>
      <p class="text-sm text-slate-500 mt-1">Are you sure you want to remove this employee? This action is recorded in the system audit logs.</p>
    </div>
    <div class="p-6 flex justify-end gap-3">
      <button type="button" id="cancelDeleteEmployeeModal" class="px-5 py-2 text-xs font-bold uppercase text-slate-500 hover:text-slate-800 transition-colors">
        Cancel
      </button>
      <button type="button" id="confirmDeleteEmployeeModal" class="px-5 py-2 bg-red-600 text-white text-xs font-bold uppercase tracking-wider hover:bg-red-700 transition-colors">
        Delete Record
      </button>
    </div>
  </div>
</div>

<script>
// Logic remains similar but cleaned up for the new UI selectors
document.querySelectorAll('[data-employee-card]').forEach(card => {
  card.addEventListener('click', (e) => {
    if (e.target.closest('[data-stop-card]')) return;
    const url = card.getAttribute('data-detail-url');
    if (url) window.location.href = url;
  });
});

const deleteModal = document.getElementById('deleteEmployeeModal');
const confirmBtn = document.getElementById('confirmDeleteEmployeeModal');
const cancelBtn = document.getElementById('cancelDeleteEmployeeModal');
let activeForm = null;

document.querySelectorAll('form[action="/admin/remove_employee"]').forEach(form => {
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    activeForm = form;
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
  });
});

cancelBtn.addEventListener('click', () => {
  deleteModal.classList.add('hidden');
});

confirmBtn.addEventListener('click', () => {
  if (activeForm) activeForm.submit();
});
</script>
{% endblock %}