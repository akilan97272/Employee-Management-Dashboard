{% extends "common/layout_base.html" %}

{% block title %}Payroll Overview | TeamSync{% endblock %}

{% block page_title %}FINANCIAL_PAYROLL_SYNC{% endblock %}

{% block content %}
<div class="space-y-8">

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="border border-[var(--border)] p-6 bg-[var(--panel)]">
      <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Total Personnel</p>
      <p class="text-3xl font-black tracking-tighter">{{ payroll|length }}</p>
    </div>

    <div class="border border-[var(--border)] p-6 bg-[var(--panel)]">
      <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Mean Disbursement</p>
      <p class="text-2xl font-black tracking-tighter">₹{{ avg_salary }}</p>
    </div>

    <div class="border border-[var(--border)] p-6 bg-[var(--panel)]">
      <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Peak Compensation</p>
      <p class="text-2xl font-black tracking-tighter">₹{{ max_salary }}</p>
    </div>

    <div class="border border-[var(--border)] p-6 bg-[var(--panel)]">
      <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Total Net Payout</p>
      <p class="text-3xl font-black tracking-tighter text-blue-600">₹{{ total_salary }}</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-1 border border-[var(--border)] bg-[var(--panel)] p-8">
        <div class="flex items-center gap-3 mb-8">
            <div class="h-5 w-1 bg-blue-600"></div>
            <h3 class="text-xs font-black uppercase tracking-[0.2em]">Salary Variance</h3>
        </div>
        <div class="relative h-[300px]">
            <canvas id="payrollChart"></canvas>
        </div>
    </div>

    <div class="lg:col-span-2 border border-[var(--border)] bg-[var(--panel)] p-8">
        <div class="flex items-center gap-3 mb-8">
            <div class="h-5 w-1 bg-blue-600"></div>
            <h3 class="text-xs font-black uppercase tracking-[0.2em]">Adjustment Terminal</h3>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-[var(--border)] text-[10px] font-black uppercase tracking-widest text-slate-400">
                        <th class="pb-4">Personnel</th>
                        <th class="pb-4 text-center">Base</th>
                        <th class="pb-4 text-center">Allowances</th>
                        <th class="pb-4 text-center">Deductions</th>
                        <th class="pb-4 text-right">Net Value</th>
                        <th class="pb-4 text-right">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[var(--border)]">
                    {% for p in payroll %}
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="py-4">
                            <p class="font-bold text-sm">{{ p.name }}</p>
                            <p class="executive-mono text-[9px] text-slate-500 uppercase">ID: {{ p.employee_id }}</p>
                        </td>
                        
                        <form method="post" action="/admin/update_salary" class="contents">
                            <input type="hidden" name="employee_id" value="{{ p.employee_id }}">
                            
                            <td class="py-4 text-center">
                                <input type="number" step="0.01" name="basic_salary" value="{{ p.basic_salary | default(0) }}" 
                                       class="w-20 bg-[var(--bg)] border border-[var(--border)] p-1.5 text-xs font-bold text-center outline-none focus:border-blue-600">
                            </td>
                            
                            <td class="py-4 text-center">
                                <input type="number" step="0.01" name="allowances" value="{{ p.allowances | default(0) }}" 
                                       class="w-20 bg-[var(--bg)] border border-[var(--border)] p-1.5 text-xs font-bold text-center outline-none focus:border-blue-600">
                            </td>
                            
                            <td class="py-4 text-center">
                                <input type="number" step="0.01" name="deductions" value="{{ p.deductions | default(0) }}" 
                                       class="w-20 bg-[var(--bg)] border border-[var(--border)] p-1.5 text-xs font-bold text-center outline-none focus:border-red-600">
                            </td>
                            
                            <td class="py-4 text-right">
                                <span class="executive-mono font-bold text-blue-600">
                                    ₹{{ (p.basic_salary | default(0) + p.allowances | default(0) - p.deductions | default(0)) | round(2) }}
                                </span>
                            </td>
                            
                            <td class="py-4 text-right">
                                <button type="submit" class="px-3 py-1.5 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all">
                                    Update
                                </button>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ payroll | map(attribute='name') | list | safe if payroll else [] }};
const values = {{ payroll | map(attribute='salary') | list | safe if payroll else [] }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      data: values,
      backgroundColor: '#2563eb',
      borderRadius: 2
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false }},
    scales: {
      y: { ticks: { font: { family: 'JetBrains Mono', size: 9 }}},
      x: { grid: { color: "#f1f5f9" }, ticks: { font: { family: 'JetBrains Mono', size: 9 }}}
    }
  }
});
</script>
{% endblock %}