{% extends "common/layout_base.html" %}

{% block title %}Command Center | TeamSync{% endblock %}

{% block page_title %}COMMAND_CENTER{% endblock %}

{% block content %}
<div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-12">

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">No. of Employees</p>
        <p class="text-5xl font-black tracking-tighter">{{ employees|length }}</p>
      </div>
      <div class="w-12 h-12 bg-blue-50 flex items-center justify-center text-blue-600">
          <i class="bi bi-people-fill text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Blocks Occupied</p>
        <p class="text-5xl font-black tracking-tighter">{{ blocks|length }}</p>
      </div>
      <div class="w-12 h-12 bg-slate-50 flex items-center justify-center text-slate-600">
          <i class="bi bi-building-fill text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">RFID Alerts</p>
        <p class="text-5xl font-black tracking-tighter {% if unknown_rfids %}text-red-600{% endif %}">{{ unknown_rfids|length }}</p>
      </div>
      <div class="w-12 h-12 {% if unknown_rfids %}bg-red-50 text-red-600{% else %}bg-slate-50 text-slate-600{% endif %} flex items-center justify-center">
          <i class="bi bi-broadcast-pin text-2xl"></i>
      </div>
    </div>
  </div>

</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8 lg:col-span-2">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Blocks Visualization</h2>
    </div>

    {% if blocks %}
    <div class="grid md:grid-cols-2 gap-4">
      {% for block in blocks %}
      <div onclick="openModal('{{block.location_name}}','{{block.room_no}}',{{block.count}})"
           class="p-6 border border-[var(--border)] hover:border-blue-600 transition cursor-pointer group bg-[var(--bg)]">
        <div class="flex justify-between items-end mb-4">
          <div>
            <h4 class="text-sm font-black uppercase tracking-tight">{{ block.location_name }}</h4>
            <p class="executive-mono text-slate-500">ROOM_{{ block.room_no }}</p>
          </div>
          <span class="text-3xl font-black text-blue-600">{{ block.count }}</span>
        </div>
        <div class="h-1 w-full bg-slate-100">
          <div class="h-full bg-blue-600" style="width: calc({{ block.count }} * 10%)"></div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="py-12 border border-dashed border-slate-200 text-center">
        <p class="executive-mono text-slate-400 uppercase tracking-widest text-[10px]">No active room data available</p>
    </div>
    {% endif %}
  </div>

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Payroll Distribution</h2>
    </div>
    <div class="relative h-[250px]">
        <canvas id="payrollChart"></canvas>
    </div>
  </div>

</div>

<div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-12">

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Recent Attendance Sync</h2>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b border-[var(--border)] text-[10px] font-black uppercase tracking-widest text-slate-400">
                    <th class="pb-4">Personnel</th>
                    <th class="pb-4">Department</th>
                    <th class="pb-4 text-right">Total Hours</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[var(--border)]">
                {% for emp in employees %}
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="py-4 font-bold text-sm">{{ emp.name }}</td>
                    <td class="py-4 executive-mono text-slate-500 uppercase">{{ emp.department }}</td>
                    <td class="py-4 text-right executive-mono font-bold text-blue-600">{{ emp.total_hours|default('0.00') }} HRS</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

  <div class="space-y-6">
    <div class="border border-[var(--border)] bg-[var(--panel)] p-8 border-t-4 border-blue-600">
      <h3 class="text-xs font-black uppercase tracking-[0.3em] mb-8">Register New Employee</h3>
      <form method="post" action="/admin/add_employee" class="space-y-4">
        <input class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="name" placeholder="Full Name" required />
        <div class="grid grid-cols-2 gap-4">
            <input class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="email" placeholder="Email Address" required />
            <input class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="rfid_tag" placeholder="RFID Tag ID" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
            <select name="role" class="border border-[var(--border)] p-4 text-xs font-black uppercase bg-[var(--bg)] outline-none focus:border-blue-600">
              <option value="employee">Employee</option><option value="admin">Admin</option><option value="manager">Manager</option>
            </select>
            <select name="department" class="border border-[var(--border)] p-4 text-xs font-black uppercase bg-[var(--bg)] outline-none focus:border-blue-600">
              <option>IT</option><option>HR</option><option>Finance</option>
            </select>
        </div>
        <button class="w-full py-4 bg-slate-900 text-white font-black text-xs uppercase tracking-widest hover:bg-blue-600 transition-all" type="submit">
          Add Personnel
        </button>
      </form>
    </div>

    <div class="border border-[var(--border)] bg-[var(--panel)] p-8 border-t-4 border-red-600">
      <h3 class="text-xs font-black uppercase tracking-[0.3em] mb-6 text-red-600">Deactivate Account</h3>
      <form method="post" action="/admin/remove_employee" class="flex gap-4">
        <input class="flex-1 border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-red-600" name="employee_id" placeholder="Enter Employee ID" required />
        <button class="px-8 bg-red-600 text-white font-black text-xs uppercase tracking-widest hover:bg-red-700 transition-all">Remove</button>
      </form>
    </div>
  </div>
</div>

<div id="modal" class="hidden fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex justify-center items-center p-4">
  <div class="bg-[var(--panel)] border border-[var(--border)] p-10 max-w-sm w-full relative">
    <div class="h-1 w-full bg-blue-600 absolute top-0 left-0"></div>
    <h3 id="modalTitle" class="text-xs font-black uppercase tracking-widest mb-8 text-blue-600"></h3>
    <div id="modalBody" class="space-y-4"></div>
    <button onclick="closeModal()" class="w-full mt-10 py-4 bg-slate-900 text-white font-black text-xs uppercase tracking-widest hover:bg-blue-600 transition-all">Close Window</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function openModal(loc, room, count){
  document.getElementById("modalTitle").innerHTML = `${loc} // ROOM ${room}`;
  fetch(`/api/block_persons?location=${loc}&room=${room}`)
    .then(r=>r.json())
    .then(data=>{
      let html="";
      if(data.persons.length===0) html = "<p class='executive-mono text-slate-400'>Currently Vacant</p>";
      else data.persons.forEach(p=> html += `<div class='p-3 border border-[var(--border)] font-bold text-sm'>${p.name}</div>`);
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("modal").classList.remove("hidden");
    });
}
function closeModal(){ document.getElementById("modal").classList.add("hidden"); }

// Payroll Chart Fix
const labels = {{ payroll|map(attribute='name')|list|safe if payroll else [] }};
const values = {{ payroll|map(attribute='salary')|list|safe if payroll else [] }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      data: values,
      backgroundColor: '#2563eb',
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false }},
    scales: {
      y: { beginAtZero:true, grid:{color:"#f1f5f9"}, ticks:{font:{family:'Inter', size:10}}},
      x: { grid:{display:false}, ticks:{font:{family:'Inter', size:10}}}
    }
  }
});
</script>
{% endblock %}