{% extends "common/layout_base.html" %}

{% block title %}Executive Intelligence | TeamSync{% endblock %}
{% block page_title %}SYSTEM_OVERVIEW{% endblock %}

{% block content %}

<!-- HEADER -->
<div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-slate-200 pb-8">
  <div class="flex items-center gap-6">
    <div class="relative">
      {% if user.photo_blob or user.photo_path %}
        <img src="{% if user.photo_blob %}/employee/photo/{{ user.employee_id }}{% else %}{{ user.photo_path }}{% endif %}"
             class="w-20 h-20 object-cover border-2 border-slate-900 shadow-[4px_4px_0px_#cbd5e1]" />
      {% else %}
        <div class="w-20 h-20 bg-slate-900 text-white flex items-center justify-center text-2xl font-light">
          {{ user.name[0]|upper }}
        </div>
      {% endif %}
      <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white text-[8px] font-black px-2 py-1">ADMIN</div>
    </div>
    <div>
      <h1 class="text-3xl font-light tracking-tighter uppercase">
        {{ user.name }} <span class="font-black text-blue-600">.</span>
      </h1>
      <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">
        Personnel ID: {{ user.employee_id }} — System Access: Level 4
      </p>
    </div>
  </div>
  <div class="text-right">
    <span class="text-[10px] font-black uppercase tracking-widest">Command Center</span><br>
    <span class="text-[10px] font-mono text-slate-400">{{ current_time }}</span>
  </div>
</div>

<!-- METRICS -->
<div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-10">
  <div class="bg-white border p-5">
    <div class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-3">Live Presence</div>
    <div class="text-4xl font-black">{{ present_count }}</div>
  </div>
  <div class="bg-white border p-5">
    <div class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-3">Blocks</div>
    <div class="text-4xl font-black">{{ blocks|length }}</div>
  </div>
  <div class="bg-white border p-5 border-b-4 border-b-red-500">
    <div class="text-[9px] font-black uppercase tracking-widest text-red-500 mb-3">Absences</div>
    <div class="text-4xl font-black text-red-600">{{ absentee_count }}</div>
  </div>
  <div class="bg-white border p-5 {% if unknown_rfids %}bg-red-50 animate-pulse{% endif %}">
    <div class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-3">RFID Alerts</div>
    <div class="text-4xl font-black {% if unknown_rfids %}text-red-600{% endif %}">
      {{ unknown_rfids|length }}
    </div>
  </div>
  <div class="bg-white border p-5">
    <div class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-3">Invalid Rooms</div>
    <div class="text-4xl font-black {% if inappropriate_entries %}text-red-600{% else %}text-green-600{% endif %}">
      {{ inappropriate_entries|length }}
    </div>
  </div>
</div>

<!-- BLOCK VISUALIZATION -->
<div class="bg-slate-50 border p-8 mb-12">
  <h2 class="text-sm font-black uppercase tracking-widest mb-8">Block Visualization</h2>

  {% if blocks %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-px bg-slate-200">
    {% for block in blocks %}
    <div onclick="openModal('{{ block.location_name }}','{{ block.room_no }}',{{ block.count }})"
         class="bg-white p-6 hover:bg-slate-900 hover:text-white cursor-pointer group transition-all">
      <div class="flex justify-between mb-6">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-blue-600 group-hover:text-blue-400">
            {{ block.location_name }}
          </p>
          <p class="text-lg font-black">RM_{{ block.room_no }}</p>
        </div>
        <div class="opacity-30 font-mono">{{ loop.index }}</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex-1 h-1 bg-slate-100">
          <div class="h-full bg-blue-600" style="width: {{ block.count * 10 }}%"></div>
        </div>
        <span class="text-xs font-black font-mono">{{ block.count }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-center text-slate-400 font-bold">No telemetry data</p>
  {% endif %}
</div>

<!-- PAYROLL -->
<div class="bg-white border p-8 mb-12">
  <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Payroll Distribution</p>
  <div class="h-[300px]">
    <canvas id="payrollChart"></canvas>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-center justify-center">
  <div class="bg-white w-full max-w-lg border shadow-xl">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modalTitle" class="font-black uppercase text-sm tracking-widest"></h3>
      <button onclick="closeModal()">✕</button>
    </div>
    <div id="modalBody" class="p-6"></div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function openModal(loc, room, count) {
  document.getElementById("modalTitle").innerHTML =
    `${loc} <span class="text-slate-400">///</span> ROOM ${room}
     <span class="text-amber-500">[${count}]</span>`;

  fetch(`/api/block_persons?location=${encodeURIComponent(loc)}&room=${encodeURIComponent(room)}`)
    .then(r => r.json())
    .then(data => {
      let html = "";
      if (!data.persons || data.persons.length === 0) {
        html = "<p class='text-center font-bold text-slate-500'>Currently Vacant</p>";
      } else {
        html = "<div class='space-y-2'>";
        data.persons.forEach((p, i) => {
          html += `
            <div class="flex items-center gap-3 p-3 bg-blue-50 border rounded">
              <div class="w-8 h-8 bg-blue-600 text-white flex items-center justify-center text-xs font-black">
                ${i + 1}
              </div>
              <div>
                <div class="font-bold">${p.name}</div>
                <div class="text-[10px] font-mono text-slate-400">EID_${p.employee_id}</div>
              </div>
            </div>`;
        });
        html += "</div>";
      }
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("modal").classList.remove("hidden");
    });
}

function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}

// Payroll chart
const labels = {{ payroll|map(attribute='name')|list|safe if payroll else [] }};
const values = {{ payroll|map(attribute='salary')|list|safe if payroll else [] }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels,
    datasets: [{ data: values, backgroundColor: '#2563eb' }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } }
  }
});
</script>

{% endblock %}
