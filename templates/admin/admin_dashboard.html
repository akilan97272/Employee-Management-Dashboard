{% extends "common/layout_base.html" %}

{% block title %}Command Center | TeamSync{% endblock %}

{% block page_title %}COMMAND_CENTER{% endblock %}

{% block content %}
<div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-12">

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">No. of Employees</p>
        <p class="text-5xl font-black tracking-tighter">{{ employees|length }}</p>
      </div>
      <div class="w-12 h-12 bg-blue-50 flex items-center justify-center text-blue-600">
          <i class="bi bi-people-fill text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Blocks Occupied</p>
        <p class="text-5xl font-black tracking-tighter">{{ blocks|length }}</p>
      </div>
      <div class="w-12 h-12 bg-slate-50 flex items-center justify-center text-slate-600">
          <i class="bi bi-building-fill text-2xl"></i>
      </div>
    </div>
  </div>

  <div class="border border-[var(--border)] p-8 bg-[var(--panel)] group hover:shadow-xl transition-all">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">RFID Alerts</p>
        <p class="text-5xl font-black tracking-tighter {% if unknown_rfids %}text-red-600{% endif %}">{{ unknown_rfids|length }}</p>
      </div>
      <div class="w-12 h-12 {% if unknown_rfids %}bg-red-50 text-red-600{% else %}bg-slate-50 text-slate-600{% endif %} flex items-center justify-center">
          <i class="bi bi-broadcast-pin text-2xl"></i>
      </div>
    </div>
  </div>

</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8 lg:col-span-2">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Blocks Visualization</h2>
    </div>

    {% if blocks %}
    <div class="grid md:grid-cols-2 gap-4">
      {% for block in blocks %}
      <div onclick="openModal('{{block.location_name}}','{{block.room_no}}',{{block.count}})"
           class="p-6 border border-[var(--border)] hover:border-blue-600 transition cursor-pointer group bg-[var(--bg)]">
        <div class="flex justify-between items-end mb-4">
          <div>
            <h4 class="text-sm font-black uppercase tracking-tight">{{ block.location_name }}</h4>
            <p class="executive-mono text-slate-500">ROOM_{{ block.room_no }}</p>
          </div>
          <span class="text-3xl font-black text-blue-600">{{ block.count }}</span>
        </div>
        <div class="h-1 w-full bg-slate-100">
          <div class="h-full bg-blue-600" style="width: calc({{ block.count }} * 10%)"></div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="py-12 border border-dashed border-slate-200 text-center">
        <p class="executive-mono text-slate-400 uppercase tracking-widest text-[10px]">No active room data available</p>
    </div>
    {% endif %}
  </div>

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Payroll Distribution</h2>
    </div>
    <div class="relative h-[250px]">
        <canvas id="payrollChart"></canvas>
    </div>
  </div>

</div>

<div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-12">

  <div class="border border-[var(--border)] bg-[var(--panel)] p-8">
    <div class="flex items-center gap-3 mb-8">
        <div class="h-5 w-1 bg-blue-600"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.3em]">Recent Attendance Sync</h2>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b border-[var(--border)] text-[10px] font-black uppercase tracking-widest text-slate-400">
                    <th class="pb-4">Personnel</th>
                    <th class="pb-4">Department</th>
                    <th class="pb-4 text-right">Total Hours</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[var(--border)]">
                {% for emp in employees %}
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="py-4 font-bold text-sm">{{ emp.name }}</td>
                    <td class="py-4 executive-mono text-slate-500 uppercase">{{ emp.department }}</td>
                    <td class="py-4 text-right executive-mono font-bold text-blue-600">{{ emp.total_hours|default('0.00') }} HRS</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

  <div class="space-y-6">
    <div class="border border-[var(--border)] bg-[var(--panel)] p-8 border-t-4 border-blue-600">
      <h3 class="text-xs font-black uppercase tracking-[0.3em] mb-8">Register New Employee</h3>
      <form id="addEmployeeForm" class="space-y-4">
        <input id="empName" class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="name" placeholder="Full Name" required />
        <div class="grid grid-cols-2 gap-4">
            <input id="empEmail" class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="email" placeholder="Email Address" required />
            <input id="empRfid" class="w-full border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-blue-600" name="rfid_tag" placeholder="RFID Tag ID" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
            <select id="empRole" name="role" class="border border-[var(--border)] p-4 text-xs font-black uppercase bg-[var(--bg)] outline-none focus:border-blue-600">
              <option value="employee">Employee</option><option value="admin">Admin</option><option value="manager">Manager</option>
            </select>
            <select id="empDept" name="department" class="border border-[var(--border)] p-4 text-xs font-black uppercase bg-[var(--bg)] outline-none focus:border-blue-600">
              <option>IT</option><option>HR</option><option>Finance</option>
            </select>
        </div>
        <button class="w-full py-4 bg-slate-900 text-white font-black text-xs uppercase tracking-widest hover:bg-blue-600 transition-all" type="submit">
          Add Personnel
        </button>
      </form>
    </div>

    <div class="border border-[var(--border)] bg-[var(--panel)] p-8 border-t-4 border-red-600">
      <h3 class="text-xs font-black uppercase tracking-[0.3em] mb-6 text-red-600">Deactivate Account</h3>
      <form method="post" action="/admin/remove_employee" class="flex gap-4">
        <input class="flex-1 border border-[var(--border)] p-4 text-sm font-bold bg-[var(--bg)] outline-none focus:border-red-600" name="employee_id" placeholder="Enter Employee ID" required />
        <button class="px-8 bg-red-600 text-white font-black text-xs uppercase tracking-widest hover:bg-red-700 transition-all">Remove</button>
      </form>
    </div>
  </div>
</div>

<div id="modal" class="hidden fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex justify-center items-center p-4">
  <div class="bg-[var(--panel)] border border-[var(--border)] p-10 max-w-sm w-full relative">
    <div class="h-1 w-full bg-blue-600 absolute top-0 left-0"></div>
    <h3 id="modalTitle" class="text-xs font-black uppercase tracking-widest mb-8 text-blue-600"></h3>
    <div id="modalBody" class="space-y-4"></div>
    <button onclick="closeModal()" class="w-full mt-10 py-4 bg-slate-900 text-white font-black text-xs uppercase tracking-widest hover:bg-blue-600 transition-all">Close Window</button>
  </div>
</div>

<!-- Error Popup Modal -->
<div id="errorPopup" class="hidden fixed inset-0 z-[250] bg-black/50 backdrop-blur-lg flex justify-center items-center p-4 animate-fadeIn">
  <div class="w-full max-w-sm flex flex-col bg-white rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] overflow-hidden transform transition-all duration-300">
    <!-- Icon Container with gradient background -->
    <div class="bg-gradient-to-br from-red-50 via-red-100 to-rose-100 px-8 pt-8 pb-6 flex justify-center">
      <div class="relative">
        <div class="absolute inset-0 bg-red-400/20 rounded-full blur-3xl animate-pulse"></div>
        <svg class="w-16 h-16 text-red-600 relative" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
    </div>

    <!-- Title & Message -->
    <div class="px-8 py-6">
      <h3 class="text-2xl font-bold text-slate-900 mb-2 text-center">Something Went Wrong</h3>
      <p id="errorMessage" class="text-slate-600 text-center text-sm leading-relaxed font-medium"></p>
    </div>

    <!-- Divider -->
    <div class="h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>

    <!-- Footer -->
    <div class="px-8 py-6 bg-gradient-to-b from-slate-50 to-white">
      <button onclick="closeErrorPopup()" class="w-full py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white font-bold rounded-xl hover:from-red-600 hover:to-rose-700 transition-all duration-200 shadow-lg shadow-red-200 hover:shadow-red-300 active:scale-95">
        Try Again
      </button>
    </div>
  </div>
</div>

<!-- Success Popup Modal -->
<div id="successPopup" class="hidden fixed inset-0 z-[250] bg-black/50 backdrop-blur-lg flex justify-center items-center p-4 animate-fadeIn">
  <div class="w-full max-w-2xl flex flex-col bg-white rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.3)] overflow-hidden transform transition-all duration-300 max-h-[90vh]">
    <!-- Icon Container with gradient background -->
    <div class="bg-gradient-to-br from-emerald-50 via-teal-100 to-cyan-100 px-8 pt-8 pb-6 flex justify-center relative overflow-hidden">
      <div class="absolute inset-0 opacity-20">
        <div class="absolute top-2 left-4 w-20 h-20 bg-emerald-300 rounded-full blur-3xl"></div>
        <div class="absolute bottom-2 right-4 w-16 h-16 bg-teal-300 rounded-full blur-2xl"></div>
      </div>
      <div class="relative">
        <svg class="w-20 h-20 text-emerald-600 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
      </div>
    </div>

    <!-- Title & Subtext -->
    <div class="px-8 pt-8 pb-2 text-center">
      <h3 class="text-3xl font-bold text-slate-900 mb-2">üéâ Employee Created!</h3>
      <p class="text-slate-500 text-sm font-medium">Credentials are ready to share</p>
    </div>

    <!-- Content Area - Scrollable -->
    <div class="px-8 py-6 overflow-y-auto flex-1 space-y-4">
      <!-- Employee ID -->
      <div class="group">
        <div class="flex items-center justify-between mb-2">
          <label class="text-xs font-bold text-slate-700 uppercase tracking-wider">üìã Employee ID</label>
          <span class="text-xs text-slate-400 font-medium">Click to copy</span>
        </div>
        <div class="relative flex items-center gap-2">
          <div class="flex-1 bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-xl px-4 py-4 transition-all duration-200 group-hover:border-emerald-400 group-hover:shadow-lg group-hover:shadow-emerald-100">
            <code id="successEmployeeId" class="font-mono text-lg font-bold text-emerald-900 break-all select-all">-</code>
          </div>
          <button onclick="copyToClipboard('successEmployeeId')" class="flex-shrink-0 p-3 bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all duration-200 shadow-lg shadow-emerald-200 hover:shadow-emerald-300 active:scale-90" title="Copy Employee ID">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 011 1v2h4V4a1 1 0 011-1h2a1 1 0 011 1v2h1a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h1V3zM4 7h12v10H4V7z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Username -->
      <div class="group">
        <div class="flex items-center justify-between mb-2">
          <label class="text-xs font-bold text-slate-700 uppercase tracking-wider">üë§ Username</label>
          <span class="text-xs text-slate-400 font-medium">Click to copy</span>
        </div>
        <div class="relative flex items-center gap-2">
          <div class="flex-1 bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl px-4 py-4 transition-all duration-200 group-hover:border-blue-400 group-hover:shadow-lg group-hover:shadow-blue-100">
            <code id="successUsername" class="font-mono text-lg font-bold text-blue-900 break-all select-all">-</code>
          </div>
          <button onclick="copyToClipboard('successUsername')" class="flex-shrink-0 p-3 bg-gradient-to-br from-blue-500 to-cyan-600 text-white rounded-xl hover:from-blue-600 hover:to-cyan-700 transition-all duration-200 shadow-lg shadow-blue-200 hover:shadow-blue-300 active:scale-90" title="Copy Username">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 011 1v2h4V4a1 1 0 011-1h2a1 1 0 011 1v2h1a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h1V3zM4 7h12v10H4V7z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Password -->
      <div class="group">
        <div class="flex items-center justify-between mb-2">
          <label class="text-xs font-bold text-slate-700 uppercase tracking-wider">üîê Password</label>
          <span class="text-xs text-slate-400 font-medium">Click to copy</span>
        </div>
        <div class="relative flex items-center gap-2">
          <div class="flex-1 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl px-4 py-4 transition-all duration-200 group-hover:border-purple-400 group-hover:shadow-lg group-hover:shadow-purple-100">
            <code id="successPassword" class="font-mono text-lg font-bold text-purple-900 break-all select-all">-</code>
          </div>
          <button onclick="copyToClipboard('successPassword')" class="flex-shrink-0 p-3 bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-xl hover:from-purple-600 hover:to-pink-700 transition-all duration-200 shadow-lg shadow-purple-200 hover:shadow-purple-300 active:scale-90" title="Copy Password">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 011 1v2h4V4a1 1 0 011-1h2a1 1 0 011 1v2h1a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h1V3zM4 7h12v10H4V7z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Important Notice -->
      <div class="mt-6 bg-gradient-to-br from-amber-50 to-orange-50 border-l-4 border-amber-500 rounded-2xl p-4 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-amber-200 rounded-full blur-3xl opacity-20 -z-10"></div>
        <div class="flex gap-3">
          <span class="text-2xl flex-shrink-0 mt-0.5">‚ö†Ô∏è</span>
          <div>
            <p class="text-sm font-bold text-amber-900 mb-1">Keep It Secure!</p>
            <p class="text-xs text-amber-800 leading-relaxed">Share credentials through a secure channel. This is the only time the password will be displayed. Once you close this dialog, you cannot recover the password.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Divider -->
    <div class="h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>

    <!-- Footer -->
    <div class="px-8 py-4 bg-gradient-to-b from-slate-50 to-white flex gap-3 justify-end">
      <button onclick="closeSuccessPopup();" class="px-6 py-3 text-slate-700 font-bold rounded-xl hover:bg-slate-100 transition-all duration-200">
        View Later
      </button>
      <button onclick="closeSuccessPopup(); resetAddEmployeeForm();" class="px-8 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all duration-200 shadow-lg shadow-emerald-200 hover:shadow-emerald-300 active:scale-95">
        Add Another
      </button>
    </div>
  </div>
</div>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .animate-bounce {
    animation: bounce 2s infinite;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Function to open error popup
function openErrorPopup(message) {
  document.getElementById("errorMessage").textContent = message;
  document.getElementById("errorPopup").classList.remove("hidden");
}

// Function to close error popup
function closeErrorPopup() {
  document.getElementById("errorPopup").classList.add("hidden");
}

// Function to open success popup with employee data
function openSuccessPopup(employeeId, username, password) {
  document.getElementById("successEmployeeId").textContent = employeeId;
  document.getElementById("successUsername").textContent = username;
  document.getElementById("successPassword").textContent = password;
  document.getElementById("successPopup").classList.remove("hidden");
}

// Function to close success popup
function closeSuccessPopup() {
  document.getElementById("successPopup").classList.add("hidden");
}

// Function to copy text to clipboard
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent || element.value;
  
  navigator.clipboard.writeText(text).then(() => {
    // Show brief feedback
    const originalText = element.textContent;
    element.textContent = "‚úì Copied!";
    element.style.background = "#dcfce7";
    element.style.color = "#166534";
    
    setTimeout(() => {
      element.textContent = originalText;
      element.style.background = "";
      element.style.color = "";
    }, 1500);
  }).catch(err => {
    console.error("Failed to copy:", err);
    // Fallback for older browsers
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
  });
}

// Function to reset the add employee form
function resetAddEmployeeForm() {
  document.getElementById("addEmployeeForm").reset();
}

// Form submission handler
document.getElementById("addEmployeeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const formData = new FormData(document.getElementById("addEmployeeForm"));
  
  try {
    const response = await fetch("/admin/add_employee", {
      method: "POST",
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      // Error response
      openErrorPopup(data.detail || "An error occurred while adding the employee.");
    } else {
      // Success response
      openSuccessPopup(data.employee_id, data.employee_id, data.password);
    }
  } catch (error) {
    openErrorPopup("Network error: " + error.message);
    console.error("Error:", error);
  }
});

// Existing modal functions
function openModal(loc, room, count){
  document.getElementById("modalTitle").innerHTML = `${loc} // ROOM ${room}`;
  fetch(`/api/block_persons?location=${loc}&room=${room}`)
    .then(r=>r.json())
    .then(data=>{
      let html="";
      if(data.persons.length===0) html = "<p class='executive-mono text-slate-400'>Currently Vacant</p>";
      else data.persons.forEach(p=> html += `<div class='p-3 border border-[var(--border)] font-bold text-sm'>${p.name}</div>`);
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("modal").classList.remove("hidden");
    });
}
function closeModal(){ document.getElementById("modal").classList.add("hidden"); }

// Payroll Chart Fix
const labels = {{ payroll|map(attribute='name')|list|safe if payroll else [] }};
const values = {{ payroll|map(attribute='salary')|list|safe if payroll else [] }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      data: values,
      backgroundColor: '#2563eb',
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false }},
    scales: {
      y: { beginAtZero:true, grid:{color:"#f1f5f9"}, ticks:{font:{family:'Inter', size:10}}},
      x: { grid:{display:false}, ticks:{font:{family:'Inter', size:10}}}
    }
  }
});
</script>
{% endblock %}