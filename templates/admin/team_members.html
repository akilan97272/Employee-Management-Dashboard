{% extends "common/layout_base.html" %}

{% block page_title %}Team Members - {{ team.name }}{% endblock %}

{% block content %}

<style>
:root {
  --sidebar-dark: #020617;
  --bg-main: #f8fafc;
  --border-color: #e2e8f0;
  --accent-navy: #1b2552;
  --accent-emerald: #10b981;
  --radius-standard: 0.75rem;
}

body {
  background-color: var(--bg-main);
  font-family: 'Inter', system-ui, sans-serif;
  color: #1e293b;
}

.header-section {
  background: white;
  border-bottom: 1px solid var(--border-color);
  padding: 2.5rem 2rem;
  sticky top: 0;
  z-index: 40;
}

.header-title {
  font-size: 2.5rem;
  font-weight: 900;
  letter-spacing: -0.04em;
  color: #000;
}

.label-mono {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #64748b;
}

.member-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-standard);
  padding: 1.5rem;
  transition: all 0.2s ease;
  cursor: pointer;
}

.member-card:hover {
  border-color: #cbd5e1;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 0.875rem;
}

.btn-back {
  padding: 0.75rem 1.5rem;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-radius: var(--radius-standard);
  border: 1px solid var(--border-color);
  background: transparent;
  color: var(--accent-navy);
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-back:hover {
  background: #f1f5f9;
  border-color: var(--accent-navy);
}

.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  color: #cbd5e1;
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

</style>

<div class="header-section flex justify-between items-end">
  <div>
    <p class="label-mono mb-2">Team Roster</p>
    <h1 class="header-title">{{ team.name }}</h1>
  </div>
  <a href="/manager/manage_teams" class="btn-back">
    ‚Üê Back to Teams
  </a>
</div>

<div class="max-w-[1200px] mx-auto p-8">
  
  {% if members %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for member in members %}
       <div class="member-card"
         data-team-id="{{ team.id }}"
         data-team-project-id="{{ team.project_id or '' }}"
         data-team-project-name="{{ team.project.name if team.project else '' }}"
         data-employee-id="{{ member.employee_id }}"
         data-employee-name="{{ member.name }}"
         onclick="openMemberTaskModal(this)">
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="avatar bg-indigo-100 text-indigo-700">
              {{ member.name[0]|upper }}
            </div>
            <div>
              <p class="text-sm font-bold text-slate-900">{{ member.name }}</p>
              <p class="text-xs text-slate-400 font-mono">{{ member.employee_id }}</p>
            </div>
          </div>
          {% if member.role == "admin" %}
            <span class="px-2 py-1 bg-red-100 text-red-700 text-[9px] font-black uppercase rounded">Admin</span>
          {% elif member.role == "manager" %}
            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-[9px] font-black uppercase rounded">Manager</span>
          {% else %}
            <span class="px-2 py-1 bg-slate-100 text-slate-600 text-[9px] font-black uppercase rounded">Staff</span>
          {% endif %}
        </div>

        <div class="space-y-3 text-xs">
          <div class="flex justify-between">
            <span class="text-slate-500">Email:</span>
            <span class="text-slate-900 font-medium">{{ member.email or 'N/A' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-500">Department:</span>
            <span class="text-slate-900 font-medium">{{ member.department or 'N/A' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-500">Status:</span>
            <span class="font-medium">
              {% if member.is_active %}
                <span class="text-emerald-600">Active</span>
              {% else %}
                <span class="text-slate-400">Inactive</span>
              {% endif %}
            </span>
          </div>
        </div>
        <div class="mt-4">
          <h4 class="font-semibold text-xs mb-1">Assigned Tasks:</h4>
          <ul class="list-disc ml-5">
            {% for task in member.tasks %}
            <li>
              <span class="font-medium">{{ task.title }}</span>
              <span class="text-xs text-gray-400">({{ task.status }})</span>
            </li>
            {% else %}
            <li class="text-gray-400">No tasks assigned</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="mt-12 p-6 bg-slate-50 border border-slate-200 rounded">
      <p class="text-sm text-slate-600">
        <span class="font-bold text-slate-900">{{ members|length }}</span>
        total staff member{{ 's' if members|length != 1 else '' }} assigned to this team
      </p>
    </div>

  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üë•</div>
      <p class="text-lg font-bold text-slate-400 mb-2">No team members</p>
      <p class="text-sm text-slate-400">This team doesn't have any assigned staff yet.</p>
    </div>
  {% endif %}

</div>


<div id="memberTaskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
  <div class="bg-white w-full max-w-2xl p-10 border border-slate-200 relative max-h-[90vh] overflow-y-auto">
    <div class="h-2 w-full bg-slate-900 absolute top-0 left-0"></div>
    <button onclick="closeMemberTaskModal()" class="absolute top-6 right-6 text-slate-300 hover:text-slate-900">
      <i class="bi bi-x-lg text-2xl"></i>
    </button>

    <h3 class="text-2xl font-black uppercase tracking-tighter text-slate-900 mb-2">Assign Project Task</h3>
    <p id="memberTaskMeta" class="label-mono mb-2"></p>
    <p id="memberTaskProject" class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6"></p>

    <div id="memberTaskList" class="mb-8 max-h-80 overflow-y-auto pr-2">
      <!-- Populated by JS -->
    </div>

    <form action="/manager/team_tasks/create" method="POST" class="space-y-6" id="memberTaskForm">
      <input type="hidden" name="team_id" id="memberTaskTeamId">
      <input type="hidden" name="assignees" id="memberTaskAssignee">

      <div>
        <label class="label-mono mb-2 block">Task Title</label>
        <input type="text" name="title" required placeholder="E.G. Division Report" class="w-full bg-slate-50 border border-slate-200 px-4 py-3 text-xs font-black uppercase outline-none focus:border-slate-900">
      </div>

      <div>
        <label class="label-mono mb-2 block">Description</label>
        <textarea name="description" rows="3" class="w-full bg-slate-50 border border-slate-200 px-4 py-3 text-xs font-medium outline-none focus:border-slate-900"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label-mono mb-2 block">Priority</label>
          <select name="priority" class="w-full bg-slate-50 border border-slate-200 px-4 py-3 text-xs font-black uppercase outline-none focus:border-slate-900 appearance-none">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div>
          <label class="label-mono mb-2 block">Due Date</label>
          <input type="date" id="memberTaskDueDate" name="due_date" class="w-full bg-slate-50 border border-slate-200 px-4 py-3 text-xs font-black uppercase outline-none focus:border-slate-900">
        </div>
      </div>

      <p id="memberTaskProjectNote" class="text-[11px] font-bold text-amber-600 hidden">
        This team has no project linked. Assign a project to the team first.
      </p>

      <div class="flex justify-end gap-6 pt-2">
        <button type="button" onclick="closeMemberTaskModal()" class="text-[10px] font-black uppercase tracking-widest text-slate-400">Abort</button>
        <button type="submit" id="memberTaskSubmit" class="px-10 py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all">Assign Task</button>
      </div>
    </form>
  </div>
</div>

{% include 'admin/edit_task_modal.html' %}
<script>
  function getTodayIsoDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Real member tasks data from backend
  const memberTasksData = {
    {% for member in members %}
      '{{ member.employee_id }}': [
        {% for task in member.tasks %}
        {
          title: {{ task.title|tojson }},
          status: {{ task.status|tojson }},
          description: {{ task.description|tojson }},
          assigned_at: {{ task.assigned_at|tojson }},
          completed_at: {{ task.completed_at|tojson }},
          due_date: {{ task.due_date|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  function openMemberTaskModal(card) {
    const teamId = card.getAttribute('data-team-id') || '';
    const projectId = card.getAttribute('data-team-project-id') || '';
    const projectName = card.getAttribute('data-team-project-name') || '';
    const employeeId = card.getAttribute('data-employee-id') || '';
    const employeeName = card.getAttribute('data-employee-name') || '';

    document.getElementById('memberTaskTeamId').value = teamId;
    document.getElementById('memberTaskAssignee').value = employeeId;
    document.getElementById('memberTaskMeta').textContent = `Assigning to: ${employeeName} (${employeeId})`;
    document.getElementById('memberTaskProject').textContent = projectName
      ? `Project: ${projectName}`
      : 'Project: Not linked';

    // Populate the task list in the modal
    const taskListDiv = document.getElementById('memberTaskList');
    const tasks = memberTasksData[employeeId] || [];
    if (tasks.length === 0) {
      taskListDiv.innerHTML = '<div class="text-gray-400 text-sm">No tasks assigned</div>';
    } else {
      let html = '<div class="mb-2 font-bold text-slate-900">Current Tasks</div>';
      html += '<div class="space-y-3">';
      tasks.forEach((task, idx) => {
        html += `<div class=\"border border-slate-200 rounded p-3 bg-slate-50\">\n`
          + `<div class=\"font-bold text-xs mb-1\">${task.title}</div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Status: <span class=\"font-semibold\">${task.status}</span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Description: <span class=\"font-normal\">${task.description || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Assigned: <span class=\"font-normal\">${task.assigned_at || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Completed: <span class=\"font-normal\">${task.completed_at || '-'} </span></div>\n`
          + `<div class=\"text-xs text-slate-500 mb-1\">Due: <span class=\"font-normal\">${task.due_date || '-'} </span></div>\n`
          + `<div class=\"flex gap-3 mt-2\">\n`
          + `<button class=\"px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition\" onclick=\"editTask('${task.title}', ${idx}, '${task.status}')\">Edit</button>\n`
          + `<button class=\"px-3 py-1 text-xs font-bold rounded bg-red-100 text-red-700 hover:bg-red-200 transition\" onclick=\"deleteTask('${task.title}', ${idx}, '${task.status}')\">Delete</button>\n`
          + `</div>\n`
        + `</div>`;
      });
      html += '</div>';
      taskListDiv.innerHTML = html;
    }

    const projectNote = document.getElementById('memberTaskProjectNote');
    const submitBtn = document.getElementById('memberTaskSubmit');
    const dueDateInput = document.getElementById('memberTaskDueDate');
    if (dueDateInput) {
      dueDateInput.setAttribute('min', getTodayIsoDate());
    }
    if (!projectId) {
      projectNote.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      projectNote.classList.add('hidden');
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    document.getElementById('memberTaskModal').classList.remove('hidden');
  }


  function editTask(title, idx, status) {
    // Find the employeeId from the open modal context
    const employeeId = document.getElementById('memberTaskAssignee').value;
    const task = (memberTasksData[employeeId] || [])[idx];
    if (!task) return;
    document.getElementById('editTaskEmployeeId').value = employeeId;
    document.getElementById('editTaskIdx').value = idx;
    document.getElementById('editTaskTitle').value = task.title || '';
    document.getElementById('editTaskDescription').value = task.description || '';
    document.getElementById('editTaskStatus').value = task.status || 'pending';
    const editTaskDueDate = document.getElementById('editTaskDueDate');
    editTaskDueDate.setAttribute('min', getTodayIsoDate());
    editTaskDueDate.value = task.due_date || '';
    document.getElementById('editTaskModal').classList.remove('hidden');
  }

  function closeEditTaskModal() {
    document.getElementById('editTaskModal').classList.add('hidden');
  }

  // Handle edit form submit (AJAX)
  document.addEventListener('DOMContentLoaded', function() {
    const memberTaskDueDate = document.getElementById('memberTaskDueDate');
    if (memberTaskDueDate) {
      memberTaskDueDate.setAttribute('min', getTodayIsoDate());
    }
    const memberTaskForm = document.getElementById('memberTaskForm');
    if (memberTaskForm) {
      memberTaskForm.addEventListener('submit', function(e) {
        if (!memberTaskDueDate || !memberTaskDueDate.value) return;
        if (memberTaskDueDate.value < getTodayIsoDate()) {
          e.preventDefault();
          alert('Past date not allowed.');
        }
      });
    }

    const form = document.getElementById('editTaskForm');
    const editTaskDueDate = document.getElementById('editTaskDueDate');
    if (editTaskDueDate) {
      editTaskDueDate.setAttribute('min', getTodayIsoDate());
    }
    if (form) {
      form.onsubmit = async function(e) {
        e.preventDefault();
        if (editTaskDueDate && editTaskDueDate.value && editTaskDueDate.value < getTodayIsoDate()) {
          alert('Past date not allowed.');
          return;
        }
        const employeeId = document.getElementById('editTaskEmployeeId').value;
        const idx = document.getElementById('editTaskIdx').value;
        const payload = {
          employee_id: employeeId,
          idx: idx,
          title: document.getElementById('editTaskTitle').value,
          description: document.getElementById('editTaskDescription').value,
          status: document.getElementById('editTaskStatus').value,
          due_date: document.getElementById('editTaskDueDate').value
        };
        // Send to backend (implement /manager/update_task endpoint)
        const resp = await fetch('/manager/update_task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (resp.ok) {
          alert('Task updated!');
          closeEditTaskModal();
          location.reload();
        } else {
          alert('Failed to update task.');
        }
      }
    }
  });

  function deleteTask(title, idx, status) {
    if (confirm('Are you sure you want to delete task: ' + title + '?')) {
      alert('Delete functionality for task: ' + title + ' (index: ' + idx + ', status: ' + status + ')');
      // Implement delete logic here
    }
  }

  function closeMemberTaskModal() {
    document.getElementById('memberTaskModal').classList.add('hidden');
  }
</script>

{% endblock %}
