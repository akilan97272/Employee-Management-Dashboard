<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %}TeamSync | Executive{% endblock %}</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg: #ffffff;
      --side: #0f172a;
      --border: #e2e8f0;
      --text: #020617;
      --text-muted: #64748b;
    }

    [data-theme="dark"] {
      --bg: #000000;
      --side: #0a0a0a;
      --border: #262626;
      --text: #ffffff;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      transition: background 0.3s ease;
    }

    /* --- UNIFIED SIDEBAR STRUCTURE --- */
    .sidebar-fixed {
      width: 280px;
      background: var(--side);
      border-right: 1px solid var(--border);
      height: 100vh;
      position: fixed;
      left: 0; top: 0; z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .main-canvas {
      margin-left: {% if request.path == '/admin/select_dashboard' %} 0 {% else %} 280px {% endif %};
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: #94a3b8;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .nav-link:hover { color: white; background: rgba(255,255,255,0.05); }
    .nav-link.active { background: white; color: #000; }

    /* Theme Toggle Styling */
    .theme-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-center;
      transition: all 0.2s ease;
    }
    .theme-btn:hover {
      background: var(--text);
      color: var(--bg);
    }

    .executive-mono { font-family: 'JetBrains Mono', monospace; font-size: 11px; }

    @media (max-width: 1024px) {
      .sidebar-fixed { display: none; }
      .main-canvas { margin-left: 0; }
    }
  </style>
</head>
<body data-theme="light">

  {% if request.path != '/admin/select_dashboard' %}
  <aside class="sidebar-fixed">
    
    <div class="p-8">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10">
            <img src="/static/assets/logo.png" alt="TS" class="w-full h-full object-contain filter drop-shadow(0 0 5px rgba(59, 130, 246, 0.3))">
        </div>
        <div>
          <h1 class="text-xl font-black tracking-tighter text-white uppercase leading-none">TeamSync</h1>
          <span class="text-[9px] font-bold text-blue-500 tracking-[0.2em] mt-1 block">
            {% if request.path.startswith('/admin') %}ADMIN_CORE{% else %}WORKSPACE{% endif %}
          </span>
        </div>
      </div>
    </div>

    <nav class="flex-1 px-4 space-y-1">
      
      {% if request.path.startswith('/admin') %}
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 mb-2">Operations</div>
        <a href="/admin" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}">
          <i class="bi bi-grid-1x2"></i> Dashboard
        </a>
        <a href="/admin/attendance" class="nav-link">
          <i class="bi bi-stopwatch"></i> Attendance
        </a>
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 mt-8 mb-2">Management</div>
        <a href="/admin/manage_employees" class="nav-link">
          <i class="bi bi-person"></i> Manage Employees
        </a>
         <a href="/admin/manage_teams" class="nav-link">
          <i class="bi bi-people"></i> Manage Teams
        </a>
        <a href="/admin/leave_requests" class="nav-link justify-between">
          <div class="flex items-center gap-3"><i class="bi bi-calendar-check"></i> <span>Leave Approvals</span></div>
          <span id="leaveCountBadge" class="bg-blue-600 text-white text-[9px] font-black px-1.5 py-0.5 hidden">0</span>
        </a>
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 mt-8 mb-2">System</div>
        <a href="/admin/payroll" class="nav-link">
          <i class="bi bi-safe2"></i> Payroll Overview
        </a>
           <a href="/admin/unknown_rfid" class="nav-link">
         <i class="bi bi-question-diamond"></i> Unknown RFID Logs
        </a>
        <a href="/admin/email_settings" class="nav-link">
          <i class="bi bi-envelope"></i> Email Settings
        </a>
      {% else %}
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 mb-2">Main</div>
        <a href="/employee" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}">
          <i class="bi bi-grid-1x2"></i> Dashboard
        </a>
        {% if user.role == 'manager' %}
         <a href="/manager/dashboard" class="nav-link">
          <i class="bi bi-globe2"></i> Operations
        </a>
        {% endif %}
        <a href="/employee/attendance" class="nav-link">
          <i class="bi bi-stopwatch"></i> Attendance
        </a>
        <a href="/employee/tasks" class="nav-link">
          <i class="bi bi-check2-square"></i> My Tasks
        </a>
        <a href="/employee/leave" class="nav-link">
          <i class="bi bi-calendar-plus"></i> Leave Request
        </a>
        <a href="/employee/payslips" class="nav-link">
          <i class="bi bi-wallet2"></i> My Payslips
        </a>
      {% endif %}

{% if user.role == 'admin' %}
      <div class="border-t border-slate-800 my-4"></div>
      <a href="/admin/select_dashboard" class="nav-link text-blue-400">
        <i class="bi bi-arrow-left-right"></i> Switch Mode
      </a>
      {% endif %}
    </nav>
<div class="p-4 border-t border-slate-800">
{% if request.path.startswith('/employee') %}
      <a href="/employee/profile" class="flex items-center gap-3 p-3 hover:bg-slate-800/50 transition-all group">
        <div class="w-9 h-9 bg-slate-800 flex items-center justify-center text-white font-bold text-xs group-hover:bg-blue-600 transition-colors">
          {{ user.name[0] }}
        </div>
        <div class="overflow-hidden">
          <p class="text-xs font-bold text-white truncate group-hover:text-blue-400 transition-colors">{{ user.name }}</p>
          <div class="flex items-center gap-1.5">
            <p class="text-[9px] text-slate-500 font-mono font-bold tracking-widest uppercase truncate">ID: {{ user.employee_id }}</p>
          </div>
        </div>
      </a>
      {% else %}
      <div class="flex items-center gap-3 p-3 opacity-80">
        <div class="w-9 h-9 bg-slate-800 flex items-center justify-center text-white font-bold text-xs">
          {{ user.name[0] }}
        </div>
        <div class="overflow-hidden">
          <p class="text-xs font-bold text-white truncate">{{ user.name }}</p>
          <div class="flex items-center gap-1.5">
            <p class="text-[9px] text-slate-500 font-mono font-bold tracking-widest uppercase truncate">ID: {{ user.employee_id }}</p>
          </div>
        </div>
      </div>
      {% endif %}
      <a href="/logout" class="mt-2 flex items-center gap-2 px-3 py-2 text-xs font-bold text-red-500 hover:bg-red-500/10 transition-colors uppercase">
        <i class="bi bi-power"></i> Logout
      </a>
    </div>
  </aside>
  {% endif %}

  <main class="main-canvas">
    <header class="h-20 border-b border-[var(--border)] px-8 flex items-center justify-between">
      <div class="flex items-center gap-4">
          <h2 class="text-sm font-black uppercase tracking-[0.3em]">
            {% if request.path.startswith('/admin') %}COMMAND CENTER{% else %}MY WORKSPACE{% endif %}
          </h2>
      </div>
      
    <div class="flex items-center gap-6">

 <!-- CLOCK -->
<div id="clock" class="executive-mono text-[var(--text-muted)]">00:00:00</div>

{% if request.path != '/admin/select_dashboard' %}
<button id="calendarToggle" class="theme-btn flex items-center justify-center" title="AI Calendar">
  <i class="bi bi-calendar3"></i>
</button>

<button id="meetingToggle" class="theme-btn flex items-center justify-center relative" title="Meetings">
  <i class="bi bi-camera-video"></i>
  <span id="meetingBadge" class="absolute -top-1 -right-1 bg-blue-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full hidden"></span>
</button>
{% endif %}

{% if request.path.startswith('/employee') %}
<!-- CHAT ICON -->
<a href="/employee/chat"
   class="relative w-10 h-10 flex items-center justify-center
          border border-[var(--border)] 
          hover:bg-[var(--text)] hover:text-[var(--bg)]
          transition-all"
   title="Chat">
  <i class="bi bi-chat-dots"></i>

  <!-- REAL unread badge -->
  <span id="chatBadge"
        class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px]
               font-black px-1.5 py-0.5 rounded-full hidden">
  </span>
</a>
{% endif %}
{% if request.path.startswith('/admin') %}
<!-- CHAT ICON -->
<a href="/admin/settings"
   class="relative w-10 h-10 flex items-center justify-center
          border border-[var(--border)] 
          hover:bg-[var(--text)] hover:text-[var(--bg)]
          transition-all"
   title="Settings">
  <i class="bi bi-gear"></i>

</a>
{% endif %}

<!-- THEME TOGGLE -->
<button id="themeToggle"
        class="theme-btn flex items-center justify-center">
  <i class="bi bi-moon" id="themeIcon"></i>
</button>


    </header>

    <section class="p-8 lg:p-12 flex-1">
      {% block content %}{% endblock %}
    </section>

    <footer class="p-8 border-t border-[var(--border)] flex justify-between executive-mono text-[var(--text-muted)] uppercase tracking-widest">
      <div>Ver 3.6.5 // SR'S_TOUCH</div>
      <div>&copy; 2026 TeamSync </div>
    </footer>
  </main>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-[400] space-y-2"></div>

    <div id="confirmModal" class="fixed inset-0 hidden items-center justify-center z-[410]">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative bg-white rounded-2xl w-full max-w-sm mx-4 p-6 shadow-2xl">
        <h4 class="text-sm font-bold text-slate-900" id="confirmTitle">Please confirm</h4>
        <p class="text-xs text-slate-500 mt-2" id="confirmMessage"></p>
        <div class="mt-6 flex justify-end gap-2">
          <button id="confirmCancel" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-xs font-semibold">Cancel</button>
          <button id="confirmOk" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold">OK</button>
        </div>
      </div>
    </div>

  <script>
    window.showToast = function (message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      const colors = {
        info: 'bg-slate-900 text-white',
        success: 'bg-emerald-600 text-white',
        warning: 'bg-amber-500 text-white',
        error: 'bg-rose-600 text-white'
      };

      toast.className = `px-4 py-3 rounded-xl text-xs font-semibold shadow-lg ${colors[type] || colors.info}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => toast.remove(), 200);
      }, 2400);
    };

    window.showConfirm = function (message, title = 'Please confirm') {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const okBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        if (!modal || !titleEl || !messageEl || !okBtn || !cancelBtn) {
          resolve(false);
          return;
        }

        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        const cleanup = () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
        };

        const onOk = () => {
          cleanup();
          resolve(true);
        };

        const onCancel = () => {
          cleanup();
          resolve(false);
        };

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
      });
    };

    document.addEventListener('submit', async (event) => {
      const form = event.target;
      if (!(form instanceof HTMLFormElement)) return;
      const confirmMessage = form.dataset.confirm;
      if (!confirmMessage) return;

      event.preventDefault();
      const ok = window.showConfirm ? await window.showConfirm(confirmMessage) : confirm(confirmMessage);
      if (ok) form.submit();
    });
    // Theme Switcher Logic
    const toggle = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');
    
    function setTheme(t) {
      document.body.setAttribute('data-theme', t);
      icon.className = t === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
      localStorage.setItem('theme', t);
    }

    toggle.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // Initialize Theme
    setTheme(localStorage.getItem('theme') || 'light');

    // Real-time Clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB');
    }
    setInterval(updateClock, 1000); updateClock();

    // Leave Count API
    if (document.getElementById("leaveCountBadge")) {
        fetch("/api/leave_count").then(res => res.json()).then(data => {
            const badge = document.getElementById("leaveCountBadge");
            if (data.count > 0) {
                badge.textContent = data.count;
                badge.classList.remove("hidden");
            }
        });
    }
    
function updateChatBadge() {
    fetch("/api/chat/unread-count")
        .then(res => {
            if (!res.ok) return;
            return res.json();
        })
        .then(data => {
            if (!data) return;
            const badge = document.getElementById("chatBadge");
            if (!badge) return;

            if (data.count > 0) {
                badge.textContent = data.count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        })
        .catch(() => {});
}

// poll every 5 seconds
setInterval(updateChatBadge, 5000);
updateChatBadge();
</script>

  <script>
    function parseEmployeesList(value) {
      if (!value) return [];
      return value.split(',').map(item => item.trim()).filter(Boolean);
    }

    function openMeetingEmployeesModal(listValue) {
      const modal = document.getElementById('meetingEmployeesModal');
      const listEl = document.getElementById('meetingEmployeesList');
      if (!modal || !listEl) return;

      listEl.innerHTML = '';
      const items = parseEmployeesList(listValue);

      if (items.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'text-slate-500';
        empty.textContent = 'No attendees available.';
        listEl.appendChild(empty);
      } else {
        items.forEach(name => {
          const li = document.createElement('li');
          li.className = 'px-3 py-2 rounded-lg border border-slate-100 bg-white';
          li.textContent = name;
          listEl.appendChild(li);
        });
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeMeetingEmployeesModal() {
      const modal = document.getElementById('meetingEmployeesModal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function buildMeetingRow(meeting) {
      const row = document.createElement('div');
      row.className = 'border border-slate-200 rounded-2xl p-4 bg-white shadow-sm hover:shadow-md transition-all';

      const header = document.createElement('div');
      header.className = 'flex items-start justify-between gap-2';

      const titleWrap = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'text-sm font-bold text-slate-900';
      title.textContent = meeting.title || 'Meeting';
      const time = document.createElement('div');
      time.className = 'text-xs text-slate-500';
      time.textContent = meeting.meeting_datetime || '';
      titleWrap.appendChild(title);
      titleWrap.appendChild(time);

      const status = document.createElement('span');
      status.className = 'text-[10px] uppercase font-black tracking-widest px-2.5 py-1 rounded-full';
      if (meeting.status === 'Ongoing') {
        status.classList.add('bg-emerald-50', 'text-emerald-700');
      } else if (meeting.status === 'Completed') {
        status.classList.add('bg-slate-100', 'text-slate-600');
      } else {
        status.classList.add('bg-blue-50', 'text-blue-600');
      }
      status.textContent = meeting.status || 'Upcoming';

      header.appendChild(titleWrap);
      header.appendChild(status);

      const sender = document.createElement('div');
      sender.className = 'mt-2 text-xs text-slate-600';
      sender.innerHTML = `<span class="text-slate-400 uppercase tracking-widest text-[9px] font-bold">Sender</span><div class="mt-1 font-semibold text-slate-700">${meeting.sender_name || '-'} <span class="text-slate-400">(${meeting.sender_employee_id || '-'})</span></div>`;

      const employees = document.createElement('div');
      employees.className = 'mt-2 text-xs text-slate-600';

      const employeesHeader = document.createElement('div');
      employeesHeader.className = 'flex items-center justify-between gap-2';
      const employeesLabel = document.createElement('span');
      employeesLabel.className = 'text-slate-400 uppercase tracking-widest text-[9px] font-bold';
      employeesLabel.textContent = 'Employees';
      employeesHeader.appendChild(employeesLabel);

      const employeesList = document.createElement('div');
      employeesList.className = 'mt-1 text-slate-700';
      employeesList.textContent = meeting.employees || '-';

      const hasEmployees = meeting.employees && meeting.employees.trim() !== '-';
      if (hasEmployees) {
        const viewBtn = document.createElement('button');
        viewBtn.type = 'button';
        viewBtn.className = 'px-2.5 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest bg-slate-100 hover:bg-slate-200 text-slate-700';
        viewBtn.textContent = 'View';
        viewBtn.addEventListener('click', () => openMeetingEmployeesModal(meeting.employees));
        employeesHeader.appendChild(viewBtn);
      }

      employees.appendChild(employeesHeader);
      employees.appendChild(employeesList);

      const actions = document.createElement('div');
      actions.className = 'mt-3 flex flex-wrap items-center gap-2';

      if (meeting.meeting_link && meeting.status !== 'Completed') {
        const link = document.createElement('a');
        link.href = meeting.meeting_link;
        link.target = '_blank';
        link.className = 'text-xs text-blue-600 hover:underline break-all flex-1';
        link.textContent = meeting.meeting_link;

        const join = document.createElement('a');
        join.href = meeting.join_url || meeting.meeting_link;
        join.target = '_blank';
        join.className = 'px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold';
        join.textContent = 'Join';

        actions.appendChild(link);
        actions.appendChild(join);
      } else {
        const noLink = document.createElement('div');
        noLink.className = 'text-xs text-slate-400';
        noLink.textContent = meeting.status === 'Completed' ? 'Meeting completed.' : 'Meeting link not available.';
        actions.appendChild(noLink);
      }

      row.appendChild(header);
      row.appendChild(sender);
      row.appendChild(actions);
      row.appendChild(employees);
      return row;
    }

    async function loadMeetingPopup(upcomingList, pastList, emptyUpcoming, emptyPast, meetingBadge) {
      if (!upcomingList || !pastList) return;
      upcomingList.innerHTML = '';
      pastList.innerHTML = '';
      emptyUpcoming?.classList.add('hidden');
      emptyPast?.classList.add('hidden');
      try {
        const res = await fetch('/api/meetings/popup');
        if (!res.ok) return;
        const data = await res.json();
        const upcoming = Array.isArray(data.upcoming) ? data.upcoming : [];
        const past = Array.isArray(data.past) ? data.past : [];
        if (meetingBadge) {
          if (upcoming.length > 0) {
            meetingBadge.textContent = upcoming.length;
            meetingBadge.classList.remove('hidden');
          } else {
            meetingBadge.classList.add('hidden');
          }
        }

        if (upcoming.length === 0) {
          emptyUpcoming?.classList.remove('hidden');
        } else {
          upcoming.forEach(meeting => upcomingList.appendChild(buildMeetingRow(meeting)));
        }

        if (past.length === 0) {
          emptyPast?.classList.remove('hidden');
        } else {
          past.forEach(meeting => pastList.appendChild(buildMeetingRow(meeting)));
        }
      } catch (_) {}
    }

    document.addEventListener('DOMContentLoaded', () => {
      const meetingToggle = document.getElementById('meetingToggle');
      const meetingModal = document.getElementById('meetingModal');
      const meetingClose = document.getElementById('meetingClose');
      const meetingUpcomingBtn = document.getElementById('meetingUpcomingBtn');
      const meetingPastBtn = document.getElementById('meetingPastBtn');
      const meetingModalListUpcoming = document.getElementById('meetingModalListUpcoming');
      const meetingModalListPast = document.getElementById('meetingModalListPast');
      const meetingModalEmptyUpcoming = document.getElementById('meetingModalEmptyUpcoming');
      const meetingModalEmptyPast = document.getElementById('meetingModalEmptyPast');
      const meetingBadge = document.getElementById('meetingBadge');
      const meetingEmployeesClose = document.getElementById('meetingEmployeesClose');
      const meetingEmployeesModal = document.getElementById('meetingEmployeesModal');

      function showUpcomingTab() {
        meetingUpcomingBtn?.classList.add('border-blue-600', 'text-blue-700');
        meetingPastBtn?.classList.remove('border-blue-600', 'text-blue-700');
        meetingModalListUpcoming?.classList.remove('hidden');
        meetingModalListPast?.classList.add('hidden');
        meetingModalEmptyUpcoming?.classList.toggle('hidden', meetingModalListUpcoming?.children.length > 0);
        meetingModalEmptyPast?.classList.add('hidden');
      }

      function showPastTab() {
        meetingPastBtn?.classList.add('border-blue-600', 'text-blue-700');
        meetingUpcomingBtn?.classList.remove('border-blue-600', 'text-blue-700');
        meetingModalListPast?.classList.remove('hidden');
        meetingModalListUpcoming?.classList.add('hidden');
        meetingModalEmptyPast?.classList.toggle('hidden', meetingModalListPast?.children.length > 0);
        meetingModalEmptyUpcoming?.classList.add('hidden');
      }

      function openMeetingModal() {
        if (!meetingModal) return;
        meetingModal.classList.remove('hidden');
        meetingModal.classList.add('flex');
        loadMeetingPopup(meetingModalListUpcoming, meetingModalListPast, meetingModalEmptyUpcoming, meetingModalEmptyPast, meetingBadge);
        showUpcomingTab();
      }

      function closeMeetingModal() {
        if (!meetingModal) return;
        meetingModal.classList.add('hidden');
        meetingModal.classList.remove('flex');
      }

      if (meetingToggle) {
        meetingToggle.addEventListener('click', openMeetingModal);
        loadMeetingPopup(meetingModalListUpcoming, meetingModalListPast, meetingModalEmptyUpcoming, meetingModalEmptyPast, meetingBadge);
        setInterval(() => loadMeetingPopup(meetingModalListUpcoming, meetingModalListPast, meetingModalEmptyUpcoming, meetingModalEmptyPast, meetingBadge), 60000);
      }
      if (meetingClose) meetingClose.addEventListener('click', closeMeetingModal);
      if (meetingUpcomingBtn) meetingUpcomingBtn.addEventListener('click', showUpcomingTab);
      if (meetingPastBtn) meetingPastBtn.addEventListener('click', showPastTab);
      if (meetingModal) meetingModal.addEventListener('click', (e) => {
        if (e.target === meetingModal) closeMeetingModal();
      });
      if (meetingEmployeesClose) meetingEmployeesClose.addEventListener('click', closeMeetingEmployeesModal);
      if (meetingEmployeesModal) meetingEmployeesModal.addEventListener('click', (e) => {
        if (e.target === meetingEmployeesModal) closeMeetingEmployeesModal();
      });
    });
  </script>

  <!-- AI Calendar Modal (shared across pages) -->
  <div id="aiCalendarModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[300]">
    <div class="bg-white w-full max-w-5xl mx-4 border border-[var(--border)] p-6 rounded-xl max-h-[85vh] overflow-y-auto">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[10px] uppercase tracking-widest text-slate-400">AI Calendar</div>
          <h3 class="text-sm font-black uppercase tracking-widest text-slate-700">Planner</h3>
        </div>
        <div class="flex items-center gap-2">
          <button id="aiCalendarSettingsToggle" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-3 py-1 hover:border-blue-600 hover:text-blue-600">
            <i class="bi bi-gear"></i>
          </button>
          {% if user.role == 'admin' and request.path.startswith('/admin') %}
          <a href="/admin/office_holidays" class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest border border-blue-200 px-3 py-1 text-blue-700 bg-blue-50 hover:border-blue-600 hover:text-blue-800" title="Office Holidays">
            <i class="bi bi-calendar-plus"></i>
            Office Holidays
          </a>
          {% endif %}
          <button id="aiCalendarClose" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-3 py-1 hover:border-blue-600 hover:text-blue-600">Close</button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <button id="aiCalendarPrev" class="px-2 py-1 border border-[var(--border)] text-xs">◀</button>
              <button id="aiCalendarNext" class="px-2 py-1 border border-[var(--border)] text-xs">▶</button>
            </div>
            <div class="flex items-center gap-2">
              <select id="aiCalendarMonth" class="border border-[var(--border)] p-1 text-xs"></select>
              <select id="aiCalendarYear" class="border border-[var(--border)] p-1 text-xs"></select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="aiCalendarGrid"></div>
          <div class="mt-4 p-3 bg-slate-50 border border-slate-200 rounded-lg">
            <div class="text-[9px] font-bold uppercase tracking-widest text-slate-500 mb-3">Event Legend</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-red-500" title="National Holiday"></span><span class="text-[10px]">National</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-orange-500" title="State Holiday"></span><span class="text-[10px]">State Holiday</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-amber-500" title="Personal Leave"></span><span class="text-[10px]">Leave</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-purple-500" title="Office Holiday"></span><span class="text-[10px]">Office Holiday</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-blue-500" title="Meeting"></span><span class="text-[10px]">Meeting</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-emerald-500" title="Task"></span><span class="text-[10px]">Task</span></div>
              <div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full bg-slate-500" title="General"></span><span class="text-[10px]">General</span></div>
            </div>
          </div>
          <div class="mt-4 border border-[var(--border)] p-4 max-h-[260px] overflow-y-auto">
            <div class="text-[10px] uppercase tracking-widest text-slate-400">Selected Day</div>
            <div id="aiCalendarList" class="mt-3 space-y-2 text-sm text-slate-600"></div>
          </div>
        </div>

        <div class="lg:col-span-1 space-y-4">
          <div class="border border-[var(--border)] p-4">
            <div class="text-[10px] uppercase tracking-widest text-slate-400">Select Date</div>
            <input id="aiCalendarDate" type="date" class="mt-3 w-full border border-[var(--border)] p-2 text-sm" />
          </div>
          <div class="border border-[var(--border)] p-4">
            <div class="text-[10px] uppercase tracking-widest text-slate-400">Add Event</div>
            <input id="aiCalendarTitle" type="text" placeholder="Event title" class="mt-3 w-full border border-[var(--border)] p-2 text-sm" />
            <select id="aiCalendarType" class="mt-3 w-full border border-[var(--border)] p-2 text-sm">
              <option value="general">General</option>
              <option value="meeting">Meeting</option>
              <option value="task">Task</option>
              <option value="personal_leave">Personal Leave</option>
              {% if user.role == 'admin' %}
              <option value="office_holiday">Office Holiday</option>
              {% endif %}
            </select>
            {% if user.role == 'admin' %}
            <div id="aiCalendarTargetSection" class="mt-3 border border-[var(--border)] p-3 hidden">
              <div class="text-[10px] uppercase tracking-widest text-slate-400">Assign To</div>
              <label class="mt-3 block text-[10px] uppercase tracking-widest text-slate-400">Team</label>
              <select id="aiCalendarTargetTeam" class="mt-2 w-full border border-[var(--border)] p-2 text-sm"></select>
              <label class="mt-3 block text-[10px] uppercase tracking-widest text-slate-400">Employees</label>
              <input id="aiCalendarTargetSearch" type="text" class="mt-2 w-full border border-[var(--border)] p-2 text-sm" placeholder="Search employee" />
              <div id="aiCalendarTargetList" class="mt-2 max-h-[160px] overflow-y-auto border border-[var(--border)] p-2 space-y-2 text-sm"></div>
              <div class="mt-2 text-[10px] text-slate-400">Leave empty to keep it private.</div>
            </div>
            {% endif %}
            <textarea id="aiCalendarNotes" rows="3" class="mt-3 w-full border border-[var(--border)] p-2 text-sm" placeholder="Notes (optional)"></textarea>
            <button id="aiCalendarAdd" class="mt-3 w-full py-2 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-600">Add</button>
          </div>
          <div id="aiCalendarSettings" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[400]">
            <div class="bg-white w-full max-w-md mx-4 border border-[var(--border)] p-5 rounded-xl">
              <div class="flex items-center justify-between">
                <div class="text-[10px] uppercase tracking-widest text-slate-400">Holiday Settings</div>
                <button id="aiCalendarSettingsClose" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-2 py-1 hover:border-blue-600 hover:text-blue-600">Close</button>
              </div>
              <label class="mt-4 block text-[10px] uppercase tracking-widest text-slate-400">Country</label>
              <input id="aiCalendarCountrySearch" type="text" class="mt-2 w-full border border-[var(--border)] p-2 text-sm" placeholder="Search country" />
              <select id="aiCalendarCountry" class="mt-2 w-full border border-[var(--border)] p-2 text-sm"></select>
              <label class="mt-4 block text-[10px] uppercase tracking-widest text-slate-400">State / Region</label>
              <input id="aiCalendarStateSearch" type="text" class="mt-2 w-full border border-[var(--border)] p-2 text-sm" placeholder="Search state" />
              <select id="aiCalendarState" class="mt-2 w-full border border-[var(--border)] p-2 text-sm"></select>
              <button id="aiCalendarSaveSettings" type="button" class="mt-4 w-full py-2 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest hover:bg-blue-600">Save Settings</button>
            </div>
          </div>
        
        </div>
      </div>
    </div>
  </div>

  <!-- Meetings Modal (shared across pages) -->
  <div id="meetingModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[320]">
    <div class="bg-white w-full max-w-3xl mx-4 border border-[var(--border)] p-6 rounded-3xl max-h-[85vh] overflow-y-auto shadow-2xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-blue-600 text-white flex items-center justify-center">
            <i class="bi bi-camera-video"></i>
          </div>
          <div>
            <div class="text-[10px] uppercase tracking-widest text-slate-400">Meetings</div>
            <h3 class="text-sm font-black uppercase tracking-widest text-slate-700">My Meeting Links</h3>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="meetingUpcomingBtn" class="text-[10px] font-black uppercase tracking-widest border border-blue-600 text-blue-700 px-3 py-1 rounded-lg">Upcoming</button>
          <button id="meetingPastBtn" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-3 py-1 rounded-lg hover:border-blue-600 hover:text-blue-600">Past</button>
          <button id="meetingClose" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-3 py-1 rounded-lg hover:border-blue-600 hover:text-blue-600">Close</button>
        </div>
      </div>

      <div class="mt-5 space-y-4 max-h-[60vh] overflow-y-auto pr-1" id="meetingModalListUpcoming"></div>
      <div class="mt-5 space-y-4 max-h-[60vh] overflow-y-auto pr-1 hidden" id="meetingModalListPast"></div>
      <div id="meetingModalEmptyUpcoming" class="mt-8 text-sm text-slate-500 text-center hidden">No upcoming meetings.</div>
      <div id="meetingModalEmptyPast" class="mt-8 text-sm text-slate-500 text-center hidden">No past meetings.</div>
    </div>
  </div>

  <div id="meetingEmployeesModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[330]">
    <div class="bg-white w-full max-w-lg mx-4 border border-[var(--border)] p-6 rounded-2xl shadow-2xl">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[10px] uppercase tracking-widest text-slate-400">Attendees</div>
          <h3 class="text-sm font-black uppercase tracking-widest text-slate-700">Meeting Employees</h3>
        </div>
        <button id="meetingEmployeesClose" class="text-[10px] font-black uppercase tracking-widest border border-[var(--border)] px-3 py-1 rounded-lg hover:border-blue-600 hover:text-blue-600">Close</button>
      </div>
      <div class="mt-4">
        <ul id="meetingEmployeesList" class="space-y-2 text-sm text-slate-700 max-h-72 overflow-y-auto"></ul>
      </div>
    </div>
  </div>

  <script>
    // AI Calendar modal logic (calendar-specific functions)
    const calendarToggle = document.getElementById('calendarToggle');
    const calendarModal = document.getElementById('aiCalendarModal');
    const calendarClose = document.getElementById('aiCalendarClose');
    const calendarDate = document.getElementById('aiCalendarDate');
    const calendarTitle = document.getElementById('aiCalendarTitle');
    const calendarAdd = document.getElementById('aiCalendarAdd');
    const calendarList = document.getElementById('aiCalendarList');
    const calendarNotes = document.getElementById('aiCalendarNotes');
    const calendarGrid = document.getElementById('aiCalendarGrid');
    const calendarType = document.getElementById('aiCalendarType');
    const calendarTargetSection = document.getElementById('aiCalendarTargetSection');
    const calendarTargetTeam = document.getElementById('aiCalendarTargetTeam');
    const calendarTargetSearch = document.getElementById('aiCalendarTargetSearch');
    const calendarTargetList = document.getElementById('aiCalendarTargetList');
    const calendarSettingsToggle = document.getElementById('aiCalendarSettingsToggle');
    const calendarSettings = document.getElementById('aiCalendarSettings');
    const calendarSettingsClose = document.getElementById('aiCalendarSettingsClose');
    const calendarCountry = document.getElementById('aiCalendarCountry');
    const calendarState = document.getElementById('aiCalendarState');
    const calendarCountrySearch = document.getElementById('aiCalendarCountrySearch');
    const calendarStateSearch = document.getElementById('aiCalendarStateSearch');
    const calendarSaveSettings = document.getElementById('aiCalendarSaveSettings');
    const calendarPrev = document.getElementById('aiCalendarPrev');
    const calendarNext = document.getElementById('aiCalendarNext');
    const calendarMonth = document.getElementById('aiCalendarMonth');
    const calendarYear = document.getElementById('aiCalendarYear');
    let calendarEventsCache = [];
    let holidayCache = {};
    let viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth();
    let calendarSettingsLoaded = false;
    let calendarDataPromise = null;
    let allCountries = [];
    let allStates = [];
    let settingsSaveTimer = null;
    let targetEmployees = [];
    let targetTeams = [];

    async function fetchCalendarEvents() {
      const res = await fetch('/api/calendar');
      if (!res.ok) return [];
      const data = await res.json();
      return data.events || [];
    }

    async function fetchHolidays(year) {
      if (holidayCache[year]) return holidayCache[year];
      const res = await fetch(`/api/calendar/holidays?year=${year}`);
      if (!res.ok) {
        holidayCache[year] = [];
        return [];
      }
      const data = await res.json();
      holidayCache[year] = data.holidays || [];
      return holidayCache[year];
    }

    function eventColor(title, type) {
      const t = (title || '').toLowerCase();
      const ty = (type || '').toLowerCase();
      if (ty === 'national_holiday') return 'bg-red-500';
      if (ty === 'state_holiday') return 'bg-orange-500';
      if (ty === 'office_holiday') return 'bg-purple-500';
      if (ty === 'personal_leave' || ty === 'leave' || t.includes('leave')) return 'bg-amber-500';
      if (ty === 'meeting' || t.includes('meet') || t.includes('sync')) return 'bg-blue-500';
      if (ty === 'task' || t.includes('task') || t.includes('focus')) return 'bg-emerald-500';
      return 'bg-slate-500';
    }

    function renderSelectedDayList(dateStr) {
      if (!calendarList) return;
      const holidayEvents = Object.values(holidayCache).flat().filter(e => e.date === dateStr);
      const userEvents = calendarEventsCache.filter(e => e.date === dateStr);
      const events = [...holidayEvents, ...userEvents];
      if (!events.length) {
        calendarList.innerHTML = '<div class="text-[11px] text-slate-400">No events scheduled.</div>';
        return;
      }
      calendarList.innerHTML = events.map((e) => `
        <div class="flex items-center justify-between border border-[var(--border)] p-2">
          <div>
            <div class="text-[11px] text-slate-500">${e.date || '-'}</div>
            <div class="font-semibold">${e.title}</div>
            ${e.notes ? `<div class="text-[11px] text-slate-400">${e.notes}</div>` : ''}
          </div>
          ${e.id && !['office_holiday', 'national_holiday', 'state_holiday'].includes((e.type || '').toLowerCase()) ? `<button data-ai-cal-remove="${e.id}" class="text-[10px] uppercase tracking-widest text-red-500">Remove</button>` : ''}
        </div>
      `).join('');
      document.querySelectorAll('[data-ai-cal-remove]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = Number(btn.getAttribute('data-ai-cal-remove'));
          await fetch(`/api/calendar/${id}`, { method: 'DELETE' });
          calendarEventsCache = await fetchCalendarEvents();
          renderCalendar();
          renderSelectedDayList(calendarDate?.value || '');
        });
      });
    }

    function buildMonth(year, month, eventsMap) {
      const monthName = new Date(year, month, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
      const todayStr = new Date().toISOString().slice(0, 10);
      const firstDay = new Date(year, month, 1);
      const startDay = (firstDay.getDay() + 6) % 7; // Monday = 0
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let cells = '';
      for (let i = 0; i < startDay; i++) {
        cells += '<div class="h-10 border border-[var(--border)] bg-slate-50"></div>';
      }
      for (let day = 1; day <= daysInMonth; day++) {
        const mm = String(month + 1).padStart(2, '0');
        const dd = String(day).padStart(2, '0');
        const dateStr = `${year}-${mm}-${dd}`;
        const events = eventsMap[dateStr] || [];
        const dots = events.slice(0, 3).map(e => `<span class="h-1.5 w-1.5 rounded-full ${eventColor(e.title, e.type)}"></span>`).join('');
        const moreCount = events.length > 3 ? `<span class="ml-1 text-[9px] font-black text-slate-500">+${events.length - 3}</span>` : '';
        const isToday = dateStr === todayStr;
        const todayClass = isToday ? 'bg-lime-200 border-lime-500' : '';
        cells += `
          <button data-calendar-day="${dateStr}" class="h-10 border border-[var(--border)] text-xs text-slate-700 hover:bg-blue-50 relative ${todayClass}">
            <div class="absolute top-1 left-1 text-[10px] font-semibold">${day}</div>
            <div class="absolute bottom-1 right-1 flex items-center gap-1">${dots}${moreCount}</div>
          </button>
        `;
      }
      return `
        <div class="border border-[var(--border)] p-4">
          <div class="text-xs font-black uppercase tracking-widest text-slate-600 mb-3">${monthName}</div>
          <div class="grid grid-cols-7 gap-0 text-[10px] text-slate-400 mb-2">
            <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
          </div>
          <div class="grid grid-cols-7 gap-0">${cells}</div>
        </div>
      `;
    }

    function buildMonthOptions() {
      if (!calendarMonth || !calendarYear) return;
      const months = Array.from({ length: 12 }, (_, i) => new Date(2000, i, 1).toLocaleString('en-US', { month: 'long' }));
      calendarMonth.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
      const years = [];
      const currentYear = new Date().getFullYear();
      for (let y = currentYear - 10; y <= currentYear + 10; y += 1) years.push(y);
      calendarYear.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function renderCalendar() {
      if (!calendarGrid) return;
      const eventsMap = {};
      calendarEventsCache.forEach(e => {
        if (!eventsMap[e.date]) eventsMap[e.date] = [];
        eventsMap[e.date].push(e);
      });
      Object.values(holidayCache).forEach(list => {
        list.forEach(e => {
          if (!eventsMap[e.date]) eventsMap[e.date] = [];
          eventsMap[e.date].push(e);
        });
      });
      const current = buildMonth(viewYear, viewMonth, eventsMap);
      const nextDate = new Date(viewYear, viewMonth + 1, 1);
      const next = buildMonth(nextDate.getFullYear(), nextDate.getMonth(), eventsMap);
      calendarGrid.innerHTML = current + next;
      document.querySelectorAll('[data-calendar-day]').forEach(btn => {
        btn.addEventListener('click', () => {
          const dateStr = btn.getAttribute('data-calendar-day');
          if (calendarDate) calendarDate.value = dateStr;
          document.querySelectorAll('[data-calendar-day]').forEach(b => b.classList.remove('bg-yellow-200', 'border-yellow-500'));
          btn.classList.add('bg-yellow-200', 'border-yellow-500');
          renderSelectedDayList(dateStr);
        });
      });
    }

    async function openCalendar() {
      if (!calendarModal) return;
      calendarModal.classList.remove('hidden');
      calendarModal.classList.add('flex');
      if (calendarDate && !calendarDate.value) {
        const today = new Date().toISOString().slice(0, 10);
        calendarDate.value = today;
      }
      viewYear = new Date(calendarDate?.value || new Date().toISOString().slice(0, 10)).getFullYear();
      viewMonth = new Date(calendarDate?.value || new Date().toISOString().slice(0, 10)).getMonth();
      buildMonthOptions();
      if (calendarMonth) calendarMonth.value = String(viewMonth);
      if (calendarYear) calendarYear.value = String(viewYear);
      renderCalendar();
      renderSelectedDayList(calendarDate?.value || '');
      if (!calendarSettingsLoaded) {
        loadCalendarSettings().finally(() => { calendarSettingsLoaded = true; });
      }
      loadCalendarTargets();
      if (!calendarDataPromise) {
        const yearA = viewYear;
        const yearB = new Date(viewYear, viewMonth + 1, 1).getFullYear();
        calendarDataPromise = Promise.all([
          fetchCalendarEvents(),
          fetchHolidays(yearA),
          yearB !== yearA ? fetchHolidays(yearB) : Promise.resolve([])
        ]).then(([events]) => {
          calendarEventsCache = events;
        }).catch(() => {
          calendarEventsCache = [];
        }).finally(() => {
          calendarDataPromise = null;
        });
      }
      if (calendarDataPromise) {
        await calendarDataPromise;
        renderCalendar();
        renderSelectedDayList(calendarDate?.value || '');
      }
    }

    function closeCalendar() {
      if (!calendarModal) return;
      calendarModal.classList.add('hidden');
      calendarModal.classList.remove('flex');
    }

    if (calendarToggle) calendarToggle.addEventListener('click', openCalendar);
    if (calendarClose) calendarClose.addEventListener('click', closeCalendar);
    if (calendarModal) {
      calendarModal.addEventListener('click', (e) => {
        if (e.target === calendarModal) closeCalendar();
      });
    }

    if (calendarPrev) {
      calendarPrev.addEventListener('click', () => {
        viewMonth -= 1;
        if (viewMonth < 0) { viewMonth = 11; viewYear -= 1; }
        if (calendarMonth) calendarMonth.value = String(viewMonth);
        if (calendarYear) calendarYear.value = String(viewYear);
        renderCalendar();
      });
    }
    if (calendarNext) {
      calendarNext.addEventListener('click', () => {
        viewMonth += 1;
        if (viewMonth > 11) { viewMonth = 0; viewYear += 1; }
        if (calendarMonth) calendarMonth.value = String(viewMonth);
        if (calendarYear) calendarYear.value = String(viewYear);
        renderCalendar();
      });
    }
    if (calendarMonth) {
      calendarMonth.addEventListener('change', () => {
        viewMonth = Number(calendarMonth.value);
        renderCalendar();
      });
    }
    if (calendarYear) {
      calendarYear.addEventListener('change', () => {
        viewYear = Number(calendarYear.value);
        renderCalendar();
      });
    }

    if (calendarAdd) {
      calendarAdd.addEventListener('click', async () => {
        const date = calendarDate?.value || '';
        const title = (calendarTitle?.value || '').trim();
        const notes = (calendarNotes?.value || '').trim();
        const type = calendarType?.value || 'general';
        let target_employee_hashes = [];
        let target_team_id = null;
        if (calendarTargetSection && !calendarTargetSection.classList.contains('hidden')) {
          target_team_id = calendarTargetTeam?.value ? Number(calendarTargetTeam.value) : null;
          document.querySelectorAll('.ai-target-employee:checked').forEach(input => {
            target_employee_hashes.push(input.value);
          });
        }
        if (!title) return;
        await fetch('/api/calendar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date,
            title,
            notes,
            type,
            target_employee_hashes,
            target_team_id,
          })
        });
        if (calendarTitle) calendarTitle.value = '';
        if (calendarNotes) calendarNotes.value = '';
        calendarEventsCache = await fetchCalendarEvents();
        renderCalendar();
        renderSelectedDayList(date);
      });
    }


    if (calendarSettingsToggle && calendarSettings) {
      calendarSettingsToggle.addEventListener('click', () => {
        calendarSettings.classList.remove('hidden');
        calendarSettings.classList.add('flex');
      });
    }
    if (calendarSettingsClose && calendarSettings) {
      calendarSettingsClose.addEventListener('click', () => {
        calendarSettings.classList.add('hidden');
        calendarSettings.classList.remove('flex');
      });
    }
    if (calendarSettings) {
      calendarSettings.addEventListener('click', (e) => {
        if (e.target === calendarSettings) {
          calendarSettings.classList.add('hidden');
          calendarSettings.classList.remove('flex');
        }
      });
    }

    async function loadCalendarSettings() {
      if (!calendarCountry || !calendarState) return;
      const res = await fetch('/api/calendar/settings');
      if (!res.ok) return;
      const data = await res.json();
      allCountries = data.countries || [];
      allStates = data.states || [];
      renderCountryOptions();
      renderStateOptions();
      calendarCountry.value = data.country || 'IN';
      calendarState.value = data.state || '';
    }

    function renderCountryOptions(filterText = '') {
      if (!calendarCountry) return;
      const term = filterText.trim().toLowerCase();
      const list = !term
        ? allCountries
        : allCountries.filter(c => `${c.name} ${c.code}`.toLowerCase().includes(term));
      calendarCountry.innerHTML = list.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`).join('');
    }

    function renderStateOptions(filterText = '') {
      if (!calendarState) return;
      const term = filterText.trim().toLowerCase();
      const list = !term
        ? allStates
        : allStates.filter(s => `${s.name} ${s.code}`.toLowerCase().includes(term));
      calendarState.innerHTML = '<option value="">All States</option>' + list.map(s => `<option value="${s.code}">${s.name} (${s.code})</option>`).join('');
    }

    function renderTargetTeams() {
      if (!calendarTargetTeam) return;
      calendarTargetTeam.innerHTML = '<option value="">No team</option>' + targetTeams
        .map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function renderTargetEmployees(filterText = '') {
      if (!calendarTargetList) return;
      const term = filterText.trim().toLowerCase();
      const list = !term
        ? targetEmployees
        : targetEmployees.filter(e => `${e.name}`.toLowerCase().includes(term));
      calendarTargetList.innerHTML = list.map(emp => `
        <label class="flex items-center gap-2">
          <input type="checkbox" class="ai-target-employee" value="${emp.employee_id_hash}">
          <span>${emp.name}</span>
        </label>
      `).join('');
    }

    async function loadCalendarTargets() {
      if (!calendarTargetList || !calendarTargetTeam) return;
      const res = await fetch('/api/calendar/targets');
      if (!res.ok) return;
      const data = await res.json();
      targetEmployees = data.employees || [];
      targetTeams = data.teams || [];
      renderTargetTeams();
      renderTargetEmployees(calendarTargetSearch?.value || '');
    }

    async function refreshStatesForCountry(country) {
      const res = await fetch(`/api/calendar/settings?country=${encodeURIComponent(country)}`);
      if (!res.ok) return;
      const data = await res.json();
      allStates = data.states || [];
      renderStateOptions(calendarStateSearch?.value || '');
      if (calendarState) calendarState.value = '';
    }

    async function saveCalendarSettings() {
      const country = calendarCountry?.value || 'IN';
      const state = calendarState?.value || '';
      await fetch('/api/calendar/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ country, state })
      });
      holidayCache = {};
      calendarEventsCache = await fetchCalendarEvents();
      const yearA = viewYear;
      const yearB = new Date(viewYear, viewMonth + 1, 1).getFullYear();
      await fetchHolidays(yearA);
      if (yearB !== yearA) await fetchHolidays(yearB);
      renderCalendar();
      renderSelectedDayList(calendarDate?.value || '');
    }

    if (calendarSaveSettings) {
      calendarSaveSettings.addEventListener('click', async () => {
        calendarSaveSettings.disabled = true;
        const originalText = calendarSaveSettings.textContent;
        calendarSaveSettings.textContent = 'Saving...';
        try {
          await saveCalendarSettings();
          calendarSaveSettings.textContent = 'Saved';
          setTimeout(() => {
            if (calendarSettings) {
              calendarSettings.classList.add('hidden');
              calendarSettings.classList.remove('flex');
            }
            calendarSaveSettings.textContent = originalText;
            calendarSaveSettings.disabled = false;
          }, 600);
          return;
        } catch (e) {
          calendarSaveSettings.textContent = originalText;
          calendarSaveSettings.disabled = false;
        }
      });
    }

    if (calendarType && calendarTargetSection) {
      const syncTargetVisibility = () => {
        const type = calendarType.value;
        if (type === 'meeting' || type === 'task') {
          calendarTargetSection.classList.remove('hidden');
        } else {
          calendarTargetSection.classList.add('hidden');
        }
      };
      calendarType.addEventListener('change', syncTargetVisibility);
      syncTargetVisibility();
    }
    if (calendarTargetSearch && calendarTargetList) {
      calendarTargetSearch.addEventListener('input', () => {
        renderTargetEmployees(calendarTargetSearch.value);
      });
    }

    if (calendarCountrySearch && calendarCountry) {
      calendarCountrySearch.addEventListener('input', () => {
        renderCountryOptions(calendarCountrySearch.value);
      });
    }
    if (calendarStateSearch && calendarState) {
      calendarStateSearch.addEventListener('input', () => {
        renderStateOptions(calendarStateSearch.value);
      });
    }
    if (calendarCountry) {
      calendarCountry.addEventListener('change', async () => {
        const country = calendarCountry.value;
        await refreshStatesForCountry(country);
        if (settingsSaveTimer) clearTimeout(settingsSaveTimer);
        settingsSaveTimer = setTimeout(saveCalendarSettings, 400);
      });
    }
    if (calendarState) {
      calendarState.addEventListener('change', () => {
        if (settingsSaveTimer) clearTimeout(settingsSaveTimer);
        settingsSaveTimer = setTimeout(saveCalendarSettings, 400);
      });
    }

    if (calendarCountry || calendarState) {
      loadCalendarSettings();
    }
  </script>

  <script src="/static/script.js"></script>
  
</body>
</html>