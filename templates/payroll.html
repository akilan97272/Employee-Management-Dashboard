{% extends "layout_base.html" %}
{% block sidebar %}{% include "sidebar_admin.html" %}{% endblock %}
{% block page_title %}Payroll Overview{% endblock %}

{% block content %}
<div class="glass p-6 rounded-xl space-y-8">

  <!-- Summary -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="glass p-4 text-center rounded-lg">
      <p class="muted text-sm">Employees</p>
      <p class="text-2xl font-bold">{{ payroll|length }}</p>
    </div>

    <div class="glass p-4 text-center rounded-lg">
      <p class="muted text-sm">Avg Salary</p>
      <p class="text-xl font-semibold">
        ₹{{ avg_salary }}
      </p>
    </div>

    <div class="glass p-4 text-center rounded-lg">
      <p class="muted text-sm">Highest Salary</p>
      <p class="text-xl font-semibold">
        ₹{{ max_salary }}
      </p>
    </div>

    <div class="glass p-4 text-center rounded-lg">
      <p class="muted text-sm">Total Payout</p>
      <p class="text-xl font-bold text-cyan-500">
        ₹{{ total_salary }}
      </p>
    </div>
  </div>

  <!-- Payroll Chart -->
  <div class="glass p-6 rounded-xl">
    <h3 class="font-semibold mb-4">Salary Distribution</h3>
    <canvas id="payrollChart" height="120"></canvas>
  </div>

  <!-- Payroll Table -->
  <div class="glass p-6 rounded-xl overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="border-b">
        <tr>
          <th class="p-3 text-left">Name</th>
          <th class="p-3 text-center">Basic Salary</th>
          <th class="p-3 text-center">Allowances</th>
          <th class="p-3 text-center">Deductions</th>
          <th class="p-3 text-right">Net Salary</th>
          <th class="p-3 text-center">Action</th>
        </tr>
      </thead>

      <tbody>
        {% for p in payroll %}
        <tr class="border-b hover:bg-gray-200/20">
          <td class="p-2">{{ p.name }}</td>
          
          <form method="post" action="/admin/update_salary" class="contents">
            <input type="hidden" name="employee_id" value="{{ p.employee_id }}">
            
            <td class="p-2 text-center">
              <input type="number" step="0.01" name="basic_salary" value="{{ p.basic_salary | default(0) }}" 
                     class="w-24 p-1 border rounded text-sm">
            </td>
            
            <td class="p-2 text-center">
              <input type="number" step="0.01" name="allowances" value="{{ p.allowances | default(0) }}" 
                     class="w-24 p-1 border rounded text-sm">
            </td>
            
            <td class="p-2 text-center">
              <input type="number" step="0.01" name="deductions" value="{{ p.deductions | default(0) }}" 
                     class="w-24 p-1 border rounded text-sm">
            </td>
            
            <td class="p-2 text-right font-medium text-cyan-400">
              ₹{{ (p.basic_salary | default(0) + p.allowances | default(0) - p.deductions | default(0)) | round(2) }}
            </td>
            
            <td class="p-2 text-center">
              <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                Save
              </button>
            </td>
          </form>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ payroll | map(attribute='name') | list | safe }};
const values = {{ payroll | map(attribute='salary') | list | safe }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      label: "Salary (₹)",
      data: values,
      borderWidth: 2,
      borderRadius: 6
    }]
  },
  options: {
    scales: {
      y: { beginAtZero: true }
    },
    plugins: {
      legend: { display: false }
    }
  }
});
</script>

{% endblock %}
