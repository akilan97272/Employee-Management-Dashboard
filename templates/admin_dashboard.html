{% extends "layout_base.html" %}
{% block sidebar %}{% include "sidebar_admin.html" %}{% endblock %}
{% block page_title %}Command Center{% endblock %}
{% block page_subtitle %}Live Status ‚Ä¢ Team Overview{% endblock %}

{% block content %}

<!-- ====== TOP STAT CARDS ====== -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">

  <div class="glass p-6 rounded-2xl flex items-center gap-4 hover:scale-[1.02] transition cursor-pointer">
    <div class="text-4xl">üë•</div>
    <div>
      <p class="text-sm muted">Active Employees</p>
      <p class="text-3xl font-bold">{{ employees|length }}</p>
    </div>
  </div>

  <div class="glass p-6 rounded-2xl flex items-center gap-4 hover:scale-[1.02] transition cursor-pointer">
    <div class="text-4xl">üè¢</div>
    <div>
      <p class="text-sm muted">Blocks Occupied</p>
      <p class="text-3xl font-bold">{{ blocks|length }}</p>
    </div>
  </div>

  <div class="glass p-6 rounded-2xl flex items-center gap-4 hover:scale-[1.02] transition cursor-pointer">
    <div class="text-4xl">‚ùì</div>
    <div>
      <p class="text-sm muted">Unknown RFID</p>
      <p class="text-3xl font-bold text-red-300">{{ unknown_rfids|length }}</p>
    </div>
  </div>

</div>



<!-- ====== BLOCKS + PAYROLL ====== -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

  <!-- Block Visualization -->
  <div class="glass rounded-2xl p-6 lg:col-span-2">
    <h2 class="font-semibold mb-4 text-lg">Block Visualization</h2>

    {% if blocks %}
    <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
      {% for block in blocks %}
      <div onclick="openModal('{{block.location_name}}','{{block.room_no}}',{{block.count}})"
           class="p-5 rounded-xl border border-[var(--glass-border)] hover:bg-white/5 transition cursor-pointer">
        <div class="flex justify-between items-center">
          <div>
            <h4 class="font-medium">{{ block.location_name }}</h4>
            <p class="text-xs muted">Room {{ block.room_no }}</p>
          </div>
          <span class="text-xl font-bold text-[var(--accent)]">{{ block.count }}</span>
        </div>

        <div class="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
          <div class="h-full"
               style="width: calc({{ block.count }} * 10%); background: var(--accent);"></div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="muted italic">No active rooms currently.</p>
    {% endif %}
  </div>

  <!-- Payroll -->
  <div class="glass rounded-2xl p-6">
    <h2 class="font-semibold mb-4 text-lg">Payroll Overview</h2>
    <canvas id="payrollChart" height="180"></canvas>
  </div>

</div>



<!-- ====== ATTENDANCE + HR Actions ====== -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">

  <!-- Attendance Summary -->
  <div class="glass p-6 rounded-2xl">
    <h3 class="font-semibold mb-4 text-lg">Attendance Summary</h3>

    <ul class="divide-y divide-white/10">
      {% for emp in employees %}
      <li class="py-3 flex justify-between items-center">
        <div>
          <span class="font-medium">{{ emp.name }}</span>
          <p class="text-xs muted">{{ emp.role }} ‚Ä¢ {{ emp.department }}</p>
        </div>
        <span class="text-sm text-[var(--accent)]">{{ emp.total_hours|default('‚Äî') }} hrs</span>
      </li>
      {% endfor %}
    </ul>
  </div>


  <!-- Add & Remove Employees -->
  <div class="grid gap-6">

    <!-- Add Employee Form -->
    <div class="glass p-6 rounded-2xl border-l-4 border-[var(--accent)]">
      <h3 class="font-semibold mb-3">Add Employee</h3>

      <form method="post" action="/admin/add_employee" class="grid gap-3">
        <input class="form-input" name="name" placeholder="Full Name" required />
        <input class="form-input" name="email" placeholder="Email" required />
        <input class="form-input" name="rfid_tag" placeholder="RFID Tag" required />

        <select name="role" class="form-input">
          <option>employee</option><option>admin</option>
        </select>

        <select name="department" class="form-input">
          <option>IT</option><option>HR</option><option>Finance</option>
        </select>

        <button class="primary-btn w-fit px-4 py-2 mt-2" type="submit">
          ‚ûï Add Employee
        </button>
      </form>
    </div>

    <!-- Remove Employee -->
    <div class="glass p-6 rounded-2xl border-l-4 border-red-500">
      <h3 class="font-semibold mb-3 text-red-300">Remove Employee</h3>

      <form method="post" action="/admin/remove_employee" class="grid gap-3">
        <input class="form-input" name="employee_id" placeholder="Employee ID" required />

        <button class="w-fit px-4 py-2 mt-2 rounded-xl bg-red-500 hover:bg-red-400 transition">
          üóë Remove
        </button>
      </form>
    </div>

  </div>
</div>



<!-- ====== Unknown RFID ====== -->
<div class="glass rounded-2xl p-6">
  <h3 class="font-semibold mb-4 text-lg">Unknown RFID Tags</h3>

  {% if unknown_rfids %}
  <ul class="divide-y divide-white/10">
    {% for rfid in unknown_rfids %}
    <li class="py-3 flex justify-between items-center">
      <div>
        <p class="font-medium">Tag: {{ rfid.rfid_tag }}</p>
        <p class="text-xs muted">Location: {{ rfid.location }}</p>
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="muted italic">No unknown RFID tags found.</p>
  {% endif %}
</div>



<!-- ====== Modal ====== -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center p-4">
  <div class="glass p-6 rounded-2xl max-w-sm w-full">
    <h3 id="modalTitle" class="font-semibold mb-4"></h3>
    <div id="modalBody" class="space-y-2"></div>
    <button onclick="closeModal()" class="primary-btn mt-4 px-4 py-2">Close</button>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function openModal(loc, room, count){
  document.getElementById("modalTitle").innerHTML =
  `${loc} ‚Äî Room ${room} (${count})`;

  fetch(`/api/block_persons?location=${loc}&room=${room}`)
    .then(r=>r.json())
    .then(data=>{
      let html="";
      if(data.persons.length===0){
        html = "<p class='muted'>No one currently inside.</p>";
      } else {
        data.persons.forEach(p=>{
          html += `<div class='glass p-2 rounded-xl'>${p.name}</div>`;
        });
      }
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("modal").classList.remove("hidden");
    });
}

function closeModal(){
  document.getElementById("modal").classList.add("hidden");
}


// Payroll chart
const labels = {{ payroll|map(attribute='name')|list|safe }};
const values = {{ payroll|map(attribute='salary')|list|safe }};

new Chart(document.getElementById('payrollChart'), {
  type: 'bar',
  data: {
    labels,
    datasets: [{
      data: values,
      backgroundColor: 'rgba(59,130,246,0.6)',
      borderColor: '#3b82f6',
      borderWidth: 2,
      borderRadius: 8
    }]
  },
  options: {
    plugins: { legend: { display: false }},
    scales: {
      y: { beginAtZero:true, grid:{color:"#ffffff20"}},
      x: { grid:{display:false}}
    }
  }
});
</script>


{% endblock %}
