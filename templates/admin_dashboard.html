<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for payroll chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); }
    /* animated entrance */
    .appear { transform: translateY(12px); opacity: 0; animation: dropIn 600ms forwards; }
    @keyframes dropIn { to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-blue-100 to-blue-200 flex flex-col">

  <!-- NAV -->
  <nav class="glass sticky top-0 z-30 backdrop-blur-lg shadow py-4 px-6 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="w-11 h-11 rounded-lg bg-gradient-to-tr from-blue-600 to-sky-400 flex items-center justify-center text-white font-bold">AD</div>
      <h1 class="text-xl font-semibold text-blue-900">Admin Dashboard</h1>
    </div>
    <div class="flex items-center gap-4">
      <a href="/logout" class="text-red-600 font-medium hover:underline">Logout</a>
    </div>
  </nav>

  <main class="p-8 container mx-auto">
    <!-- Top stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="glass rounded-2xl p-6 shadow appear" style="animation-delay:0ms">
        <p class="text-sm text-gray-500">Active Employees</p>
        <h3 class="text-3xl font-bold text-blue-700" id="stat-employees">0</h3>
        <p class="text-xs text-gray-400 mt-2">Updated just now</p>
      </div>

      <div class="glass rounded-2xl p-6 shadow appear" style="animation-delay:120ms">
        <p class="text-sm text-gray-500">Blocks Occupied</p>
        <h3 class="text-3xl font-bold text-blue-700" id="stat-blocks">0</h3>
        <p class="text-xs text-gray-400 mt-2">Real-time view</p>
      </div>

      <div class="glass rounded-2xl p-6 shadow appear" style="animation-delay:240ms">
        <p class="text-sm text-gray-500">Unknown RFID</p>
        <h3 class="text-3xl font-bold text-blue-700" id="stat-unknown">0</h3>
        <p class="text-xs text-gray-400 mt-2">Needs review</p>
      </div>
    </section>

    <!-- Block visualization + Payroll chart -->
    <section class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Blocks -->
      <div class="glass rounded-2xl p-6 shadow col-span-2">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-800">Block Visualization</h2>
          <div class="text-sm text-gray-500">Click a block to view people</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for block in blocks %}
          <div class="p-4 rounded-lg cursor-pointer transform transition hover:scale-105 shadow hover:shadow-lg bg-white" onclick="openBlockModal({{ loop.index0 }})" data-name="{{ block.location_name }}" data-room="{{ block.room_no }}" data-count="{{ block.count }}">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-md font-medium text-gray-800">{{ block.location_name }}</h3>
                <p class="text-sm text-gray-500">Room {{ block.room_no }}</p>
              </div>
              <div class="text-blue-600 font-bold text-xl">{{ block.count }}</div>
            </div>
            <div class="mt-3 h-2 bg-gradient-to-r from-sky-300 to-blue-500 rounded-full overflow-hidden">
              <div class="h-full bg-blue-700 animate-pulse" style="width: calc({{ block.count }} * 6%);"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Payroll chart -->
      <div class="glass rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Payroll (Last Month)</h2>
        <canvas id="payrollChart" height="220"></canvas>
        <p class="text-xs text-gray-400 mt-2">Estimated at $20/hr</p>
      </div>
    </section>

    <!-- Attendance summary & Add/Remove -->
    <section class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass rounded-2xl p-6 shadow">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-gray-800">Attendance Summary</h3>
          <form id="filterForm" class="flex gap-2">
            <input name="name" placeholder="Name" class="border rounded px-3 py-2 text-sm" />
            <select name="department" class="border rounded px-3 py-2 text-sm">
              <option value="">All</option><option>IT</option><option>HR</option><option>Finance</option>
            </select>
            <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded text-sm">Filter</button>
          </form>
        </div>

        <ul id="employeeList" class="divide-y">
          {% for emp in employees %}
          <li class="py-3 flex justify-between items-center hover:bg-blue-50 transition">
            <div>
              <div class="font-medium text-gray-800">{{ emp.name }}</div>
              <div class="text-xs text-gray-500">{{ emp.role }} • {{ emp.department }}</div>
            </div>
            <div class="text-sm text-gray-600">Total: {{ emp.total_hours|default('—') }} hrs</div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <div class="glass rounded-2xl p-6 shadow">
        <h3 class="font-semibold text-gray-800 mb-4">Manage Employees</h3>

        <form method="post" action="/admin/add_employee" class="grid grid-cols-1 gap-3 mb-4">
          <input name="name" placeholder="Name" required class="border rounded px-3 py-2" />
          <input name="email" placeholder="Email" required class="border rounded px-3 py-2" />
          <input name="rfid_tag" placeholder="RFID Tag" required class="border rounded px-3 py-2" />
          <select name="role" class="border rounded px-3 py-2"><option>employee</option><option>admin</option></select>
          <select name="department" class="border rounded px-3 py-2"><option>IT</option><option>HR</option><option>Finance</option></select>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Add Employee</button>
        </form>

        <form method="post" action="/admin/remove_employee" class="flex gap-3">
          <input name="employee_id" placeholder="Employee ID to remove" required class="border rounded px-3 py-2 flex-1"/>
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Remove</button>
        </form>
      </div>
    </section>

    <!-- Unknown RFID -->
    <section class="mt-8 glass rounded-2xl p-6 shadow">
      <h3 class="font-semibold text-gray-800 mb-3">Unknown RFID Tags</h3>
      {% if unknown_rfids %}
      <ul class="divide-y">
        {% for rfid in unknown_rfids %}
        <li class="py-3 flex justify-between items-center">
          <div>
            <div class="font-medium text-gray-800">Tag: {{ rfid.rfid_tag }}</div>
            <div class="text-xs text-gray-500">Location: {{ rfid.location }} • {{ rfid.timestamp }}</div>
          </div>
          <div>
            <form method="post" action="/admin/resolve_rfid" class="inline">
              <input type="hidden" name="rfid_tag" value="{{ rfid.rfid_tag }}"/>
              <button class="bg-blue-600 text-white px-3 py-2 rounded text-sm">Resolve</button>
            </form>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500 italic">No unknown RFID tags found.</p>
      {% endif %}
    </section>
  </main>

  <!-- Footer -->
  <footer class="text-center py-4 text-gray-500 text-sm">© {{ current_year }} Admin Portal</footer>

  <!-- Block modal -->
  <div id="blockModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all">
      <div class="flex justify-between items-center mb-4">
        <h4 id="modalTitle" class="text-lg font-semibold">Block People</h4>
        <button onclick="closeBlockModal()" class="text-gray-400 hover:text-gray-700">&times;</button>
      </div>
      <div id="modalBody" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // Sample dynamic stats (replace with real data injection)
    const stats = {
      employees: {{ employees|length }},
      blocks: {{ blocks|length }},
      unknown: {{ unknown_rfids|length }}
    };
    document.getElementById('stat-employees').textContent = stats.employees;
    document.getElementById('stat-blocks').textContent = stats.blocks;
    document.getElementById('stat-unknown').textContent = stats.unknown;

    // Modal logic
    function openBlockModal(index) {
      // using dataset on clicked card
      const cards = document.querySelectorAll('[onclick^="openBlockModal"]');
      const card = cards[index];
      const name = card.dataset.name;
      const room = card.dataset.room;
      const count = card.dataset.count;
      // fetch people via API or server-rendered data
      fetch(`/api/block_persons?location=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}`)
        .then(r => r.json())
        .then(data => {
          const body = document.getElementById('modalBody');
          body.innerHTML = '';
          if (!data.persons || data.persons.length === 0) {
            body.innerHTML = '<p class="text-gray-500">No one in this block.</p>';
          } else {
            const ul = document.createElement('ul');
            ul.className = 'space-y-2';
            data.persons.forEach(p => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center';
              li.innerHTML = `<div><div class="font-medium">${p.name}</div><div class="text-xs text-gray-500">${p.role}</div></div><div class="text-sm text-gray-600">${p.present_since||''}</div>`;
              ul.appendChild(li);
            });
            body.appendChild(ul);
          }
          document.getElementById('modalTitle').textContent = `${name} - Room ${room} (${count})`;
          document.getElementById('blockModal').classList.remove('hidden');
          document.getElementById('blockModal').classList.add('flex');
        }).catch(err => {
          document.getElementById('modalBody').innerHTML = '<p class="text-red-500">Failed to load people.</p>';
          document.getElementById('blockModal').classList.remove('hidden'); document.getElementById('blockModal').classList.add('flex');
        });
    }
    function closeBlockModal() {
      document.getElementById('blockModal').classList.remove('flex'); document.getElementById('blockModal').classList.add('hidden');
    }

    // Payroll Chart (replace labels/data with server-provided values)
    const payrollLabels = {{ payroll|map(attribute='name')|list|safe }};
    const payrollValues = {{ payroll|map(attribute='salary')|list|safe }};
    const ctx = document.getElementById('payrollChart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: payrollLabels,
        datasets: [{
          label: 'Salary ($)',
          data: payrollValues,
          borderRadius: 6,
          barPercentage: 0.7
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // subtle animated list reveal
    document.querySelectorAll('.appear').forEach((el, idx) => {
      el.style.animationDelay = (idx*120)+'ms';
    });
  </script>
</body>
</html>
