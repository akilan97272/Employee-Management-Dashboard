<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %}TeamSync{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg: linear-gradient(180deg, #f5f7fb 0%, #ecf0fd 100%);
      --panel: rgba(255,255,255,0.12);
      --glass-border: rgba(255,255,255,0.18);
      --text: #021023;
      --muted: rgba(2,16,35,0.55);
      --accent: #06b6d4;
      --glass-blur: 20px;
      --shadow: 0 20px 40px rgba(2,6,23,0.12);
    }
    [data-theme="dark"]{
      --bg: linear-gradient(180deg, #060a11 0%, #0a121c 100%);
      --panel: rgba(255,255,255,0.05);
      --glass-border: rgba(255,255,255,0.10);
      --text: #e6eef6;
      --muted: rgba(230,238,246,0.60);
      --accent: #58a6ff; /* Github blue */
      --glass-blur: 22px;
      --shadow: 0 30px 60px rgba(0,0,0,0.40);
    }

    body { background: var(--bg); color: var(--text); font-family: Inter, sans-serif; }

    .glass{
      background: var(--panel);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      box-shadow: var(--shadow);
      border-radius: 14px;
    }

    .sidebar a{
      display:flex; gap:12px; align-items:center;
      padding:10px 12px; border-radius:10px;
      text-decoration:none; color:var(--text);
    }
    .sidebar a:hover{
      transform: translateX(6px);
      transition:0.16s;
      background: rgba(255,255,255,0.05);
    }

    .muted { color: var(--muted); }
    .accent { color: var(--accent); }

    /* Fix: flex sidebar structure */
    .sidebar-container {
      width: 240px;
      flex-shrink: 0;
    }

    @media (max-width:900px){
      .sidebar-container { display:none; }
      .mobile-menu-btn { display:block; }
    }

    .mobile-menu-btn { display:none; }

    .session-pill {
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.55));
      border: 1px solid var(--glass-border);
      color: var(--text);
      letter-spacing: 0.2px;
      box-shadow: 0 10px 24px rgba(2,6,23,0.08);
    }

    [data-theme="dark"] .session-pill {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      box-shadow: 0 12px 28px rgba(0,0,0,0.45);
    }

    .session-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(88,166,255,0.18);
    }

    .session-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
      background: rgba(6,182,212,0.12);
      color: var(--accent);
    }

    .session-banner {
      border: 1px solid var(--glass-border);
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.6));
      box-shadow: 0 16px 32px rgba(2,6,23,0.10);
    }

    [data-theme="dark"] .session-banner {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      box-shadow: 0 18px 36px rgba(0,0,0,0.50);
    }
  </style>
</head>

<body data-theme="light">
  <div class="min-h-screen flex">

    <!-- Sidebar injected here -->
    <div class="sidebar-container">
      {% block sidebar %}{% endblock %}
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 p-6 lg:p-8">

      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">{% block page_title %}TeamSync{% endblock %}</h1>
          <p class="muted text-sm">{% block page_subtitle %}{% endblock %}</p>
        </div>

        <div class="flex items-center gap-3">

          <!-- Theme Toggle -->
          <button id="themeToggle" class="glass px-3 py-2 rounded-lg text-sm flex items-center gap-2">
            <span id="themeIcon">ðŸŒž</span>
          </button>

          <!-- Session (header pill) -->
          <div id="headerSession" class="session-pill px-3 py-2 rounded-lg text-xs flex items-center gap-2">
            <span class="session-dot"></span>
            <span class="session-badge">ACTIVE</span>
            <span class="muted">Session</span>
            <span id="headerSessionValue" class="font-semibold">--:--</span>
          </div>

          <!-- Username -->
          {% if user %}
          <div class="glass px-3 py-2 rounded-lg text-sm muted">
            {{ user.name }}
          </div>
          {% endif %}

          <a href="/logout" class="glass px-3 py-2 rounded-lg text-sm text-red-400">Logout</a>
        </div>
      </div>

      <div id="sessionTimer" class="hidden mb-6">
        <div class="session-banner px-5 py-3 rounded-xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="session-dot"></div>
            <div>
              <div class="text-sm font-semibold">Session status</div>
              <div class="text-xs muted">Automatic sign-out is enabled</div>
            </div>
          </div>
          <div class="text-sm">
            <span class="muted">Expires in</span>
            <span id="sessionTimerValue" class="ml-2 font-semibold">--:--</span>
          </div>
        </div>
      </div>

      <!-- PAGE CONTENT -->
      <div>{% block content %}{% endblock %}</div>

      <footer class="mt-10 text-sm muted">
        Â© {{ current_year }} TeamSync
      </footer>

    </div>
  </div>

<script>
  // theme switch
  const body = document.body;
  const toggle = document.getElementById("themeToggle");

  function applyTheme(t){
    body.setAttribute("data-theme", t);
    document.getElementById("themeIcon").innerHTML = t === "dark" ? "ðŸŒ™" : "ðŸŒž";
  }

  let saved = localStorage.getItem("ts-theme") || "light";
  applyTheme(saved);

  toggle.addEventListener("click", () => {
    saved = saved === "dark" ? "light" : "dark";
    localStorage.setItem("ts-theme", saved);
    applyTheme(saved);
  });

  // session timing banner
  const timerEl = document.getElementById("sessionTimer");
  const timerVal = document.getElementById("sessionTimerValue");
  const headerSessionEl = document.getElementById("headerSession");
  const headerSessionVal = document.getElementById("headerSessionValue");
  let remainingSeconds = null;

  function formatTime(seconds){
    const m = Math.floor(seconds / 60).toString().padStart(2, "0");
    const s = Math.floor(seconds % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  function tick(){
    if (remainingSeconds === null) return;
    remainingSeconds = Math.max(0, remainingSeconds - 1);
    timerVal.textContent = formatTime(remainingSeconds);
    headerSessionVal.textContent = formatTime(remainingSeconds);
    if (remainingSeconds === 0){
      timerVal.textContent = "00:00";
      headerSessionVal.textContent = "00:00";
    }
  }

  fetch("/api/session/timing")
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (!data) return;
      const remaining = data.remaining ?? null;
      const idleRemaining = data.idle_remaining ?? null;
      if (remaining === null && idleRemaining === null) return;
      remainingSeconds = Math.min(
        remaining ?? Number.MAX_SAFE_INTEGER,
        idleRemaining ?? Number.MAX_SAFE_INTEGER
      );
      if (!Number.isFinite(remainingSeconds)) return;
      timerEl.classList.remove("hidden");
      headerSessionEl.classList.remove("hidden");
      timerVal.textContent = formatTime(remainingSeconds);
      headerSessionVal.textContent = formatTime(remainingSeconds);
      setInterval(tick, 1000);
    })
    .catch(() => {});

</script>

  <script src="/static/script.js"></script>

</body>
</html>
